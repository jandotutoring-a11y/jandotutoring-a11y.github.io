<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jando EDU - Home</title>
  <link rel="stylesheet" href="shared-styles.css">
  <style>
    /* Home page specific styles */
    .welcome-section {
      background: linear-gradient(135deg, var(--light-blue) 0%, var(--dark-blue) 100%);
      color: var(--white);
      padding: 3rem 0;
      text-align: center;
      margin: 0 0 2rem 0;
      width: 100%;
    }

    .welcome-section h1 {
      font-size: 2.5rem;
      margin: 0 0 1rem 0;
      font-weight: var(--font-weight-bold);
    }

    .welcome-section p {
      font-size: 1.2rem;
      margin: 0;
      opacity: 0.9;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin: 2rem 0;
    }

    .dashboard-card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
    }

    .dashboard-card h2 {
      color: var(--dark-blue);
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
    }

    .progress-bar {
      background: var(--gray-200);
      border-radius: 1rem;
      height: 1rem;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--orange) 0%, var(--light-blue) 100%);
      height: 100%;
      border-radius: 1rem;
      transition: width 0.3s ease;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: var(--font-weight-bold);
      color: var(--orange);
      margin: 0;
    }

    .stat-label {
      color: var(--gray-600);
      font-size: 0.9rem;
      margin: 0;
    }

    .game-link {
      display: inline-block;
      background: var(--orange);
      color: var(--white);
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: var(--font-weight-medium);
      transition: all 0.2s ease;
      margin: 0.5rem 0;
    }

    .game-link:hover {
      background: var(--secondary-orange-dark);
      transform: translateY(-1px);
    }

    .resource-list {
      list-style: none;
      padding: 0;
    }

    .resource-list li {
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: 0.5rem;
      margin: 0.5rem 0;
      border-left: 4px solid var(--light-blue);
    }

    .resource-list a {
      color: var(--dark-blue);
      text-decoration: none;
      font-weight: var(--font-weight-medium);
    }

    .resource-list a:hover {
      text-decoration: underline;
    }

    .loading-placeholder {
      text-align: center;
      color: var(--gray-600);
      font-style: italic;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <!-- Authentication Modal -->
  <div id="authModal">
    <div id="authModalContent">
      <h2>Welcome to Jando EDU!</h2>
      <p>Please enter your unique student code to access your games and track your progress.</p>
      <input type="text" id="studentCodeInput" placeholder="Enter your student code" maxlength="20">
      <div id="authError" style="display: none; color: var(--accent-red); margin: 0.5rem 0; font-size: 0.875rem;"></div>
      <button id="authLoginBtn" onclick="jandoAuth.authenticateUser()">Login</button>
    </div>
  </div>

  <header>
    <div class="header-content">
      <div class="header-left">
        <img src="https://i.imgur.com/QIdMEsB.png" alt="Jando EDU Logo" class="logo">
      </div>
      <div class="header-right">
        <span id="userGreeting" style="display: none;"></span>
        <div class="menu-container">
          <button id="menuBtn" class="menu-button">‚ò∞ Menu</button>
          <div id="menuDropdown" class="menu-dropdown">
            <a href="index.html" class="menu-item">Home</a>
            <a href="learning-hub.html" class="menu-item">Learning Hub</a>
            <a href="games.html" class="menu-item">Games</a>
            <a href="reward.html" class="menu-item">My Rewards</a>
            <button class="menu-logout" onclick="jandoAuth.logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="welcome-section">
    <h1 id="welcomeTitle">Welcome to Your Learning Dashboard!</h1>
    <p id="welcomeSubtitle">Track your progress, play games, and discover new challenges</p>
  </div>

  <div class="container" style="padding: 2rem; max-width: 1400px;">
    <!-- Quick Action Cards -->
    <div class="quick-actions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
      <div class="action-card" style="background: linear-gradient(135deg, var(--orange) 0%, #ff6b35 100%); color: white; padding: 2rem; border-radius: 1rem; text-align: center; cursor: pointer; transition: transform 0.3s ease;" onclick="window.location.href='learning-hub.html'">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
        <h3 style="margin: 0 0 0.5rem 0;">Learning Hub</h3>
        <p style="margin: 0; opacity: 0.9;">Explore interactive lessons</p>
      </div>
      <div class="action-card" style="background: linear-gradient(135deg, var(--light-blue) 0%, var(--dark-blue) 100%); color: white; padding: 2rem; border-radius: 1rem; text-align: center; cursor: pointer; transition: transform 0.3s ease;" onclick="window.location.href='games.html'">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üéÆ</div>
        <h3 style="margin: 0 0 0.5rem 0;">Play Games</h3>
        <p style="margin: 0; opacity: 0.9;">Fun educational games</p>
      </div>
      <div class="action-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 2rem; border-radius: 1rem; text-align: center; cursor: pointer; transition: transform 0.3s ease;" onclick="window.location.href='reward.html'">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üèÜ</div>
        <h3 style="margin: 0 0 0.5rem 0;">My Rewards</h3>
        <p style="margin: 0; opacity: 0.9;">View your achievements</p>
      </div>
    </div>

    <style>
      .action-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      }
    </style>

    <div class="dashboard-grid">
      <!-- Recent Activity Card -->
      <div class="dashboard-card">
        <h2>Your Learning Journey</h2>
        <div id="activityContent">
          <div class="loading-placeholder">Loading your recent activity...</div>
        </div>
      </div>

      <!-- Quick Access Card -->
      <div class="dashboard-card">
        <h2>Quick Access</h2>
        <p>Jump back into your learning:</p>
        <div style="margin: 1rem 0;">
          <a href="learning-hub.html" class="game-link" style="display: block; margin: 0.5rem 0;">üìö Continue Learning</a>
          <a href="games.html" class="game-link" style="display: block; margin: 0.5rem 0;">üéÆ Play Games</a>
          <div id="quickGameLinks" style="margin-top: 1rem;"></div>
        </div>
      </div>

      <!-- Rewards Card -->
      <div class="dashboard-card">
        <h2>Recent Rewards</h2>
        <div id="rewardsContent">
          <div class="loading-placeholder">Loading your rewards...</div>
        </div>
      </div>

      <!-- Recommended for You Card -->
      <div class="dashboard-card">
        <h2>Recommended for You</h2>
        <ul class="resource-list">
          <li><a href="learning-hub.html">üìö Learning Hub - Interactive Modules</a></li>
          <li><a href="learning-hub.html?subject=mathematics">üßÆ Mathematics Lessons</a></li>
          <li><a href="games.html">üéÆ Educational Games</a></li>
          <li><a href="#" onclick="showComingSoon()">üì∫ Video Library (Coming Soon)</a></li>
        </ul>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 Jando EDU. All rights reserved. | <a href="https://www.jandotutoring.com/privacy-policy" target="_blank">Privacy Policy</a> | <a href="https://www.jandotutoring.com/contact-us" target="_blank">Contact</a></p>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script>
    // Dashboard specific functionality
    document.addEventListener('DOMContentLoaded', () => {
      // Load user data when authenticated
      if (window.jandoAuth) {
        const checkAuth = setInterval(() => {
          if (jandoAuth.isAuthenticated()) {
            loadDashboardData();
            clearInterval(checkAuth);
          }
        }, 100);
      }
      
      // Listen for auth completion to refresh dashboard
      window.addEventListener('jandoAuthComplete', (event) => {
        setTimeout(() => loadDashboardData(), 100); // Small delay to ensure everything is ready
      });
    });

    async function loadDashboardData() {
      const user = jandoAuth.getCurrentUser();
      if (!user) return;

      // Update welcome message with user's name and year
      const welcomeTitle = document.getElementById('welcomeTitle');
      const welcomeSubtitle = document.getElementById('welcomeSubtitle');
      
      let userYear = user.yearLevel || user.year || user.Year || user['Year Level'] || user.grade || user.Grade;
      if (userYear) {
        userYear = userYear.toString().replace(/[^0-9]/g, '');
        welcomeTitle.textContent = `Welcome back, ${user.name}!`;
        welcomeSubtitle.textContent = `Ready for some Year ${userYear} learning adventures?`;
      } else {
        welcomeTitle.textContent = `Welcome back, ${user.name}!`;
        welcomeSubtitle.textContent = 'Ready for some learning adventures?';
      }

      try {
        // Load real user data for learning journey
        const activityContent = document.getElementById('activityContent');
        
        // Get actual user progress data
        fetchUserLearningData(user.code).then(data => {
          const modulesStarted = data.modulesCompleted || 0;
          const gamesPlayed = data.gamesPlayed || 0;
          const averageScore = data.averageScore || 0;
          const weekProgress = data.weekProgress || 0;
          
          activityContent.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin: 1rem 0;">
              <div style="text-align: center;">
                <p class="stat-number">${modulesStarted}</p>
                <p class="stat-label">Modules Completed</p>
              </div>
              <div style="text-align: center;">
                <p class="stat-number">${gamesPlayed}</p>
                <p class="stat-label">Games Played</p>
              </div>
              <div style="text-align: center;">
                <p class="stat-number">${averageScore > 0 ? averageScore + '%' : '--'}</p>
                <p class="stat-label">Average Score</p>
              </div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${weekProgress}%;"></div>
            </div>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--gray-600);">
              Learning Progress: ${weekProgress}% Complete
            </p>
          `;
        }).catch(error => {
          console.log('Using sample data for learning journey');
          activityContent.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p style="color: var(--gray-600); margin: 0;">üìö Start your learning journey!</p>
              <a href="learning-hub.html" class="btn btn-primary" style="margin-top: 1rem; display: inline-block; text-decoration: none;">Begin Learning</a>
            </div>
          `;
        });

        // Load quick game links based on user's year level
        const quickGameLinks = document.getElementById('quickGameLinks');
        if (userYear === '6') {
          quickGameLinks.innerHTML = `
            <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem; margin-top: 1rem;">
              <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">üéØ Year 6 Games:</p>
              <a href="Y6M.W1.1.html" class="game-link" style="display: block; margin: 0.25rem 0; font-size: 0.875rem; padding: 0.5rem 1rem;">üî¢ Place Value</a>
              <a href="Y6M.W1.2.html" class="game-link" style="display: block; margin: 0.25rem 0; font-size: 0.875rem; padding: 0.5rem 1rem;">ü´ß Bubble Pop Math</a>
              <a href="Y6M.W1.3.html" class="game-link" style="display: block; margin: 0.25rem 0; font-size: 0.875rem; padding: 0.5rem 1rem;">üçï Fraction Pizza</a>
            </div>
          `;
        } else if (userYear === 9) {
          quickGameLinks.innerHTML = `
            <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem; margin-top: 1rem;">
              <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">üéØ Available for Year 9:</p>
              <a href="Y9M.W1.1.html" class="game-link" style="display: block; margin: 0.25rem 0; font-size: 0.875rem; padding: 0.5rem 1rem;">üî¢ Algebra Fundamentals</a>
            </div>
          `;
        } else {
          quickGameLinks.innerHTML = `
            <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem; margin-top: 1rem;">
              <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">üéØ Available for Year ${userYear || 'your level'}:</p>
              <p style="font-size: 0.875rem; color: var(--gray-500); font-style: italic;">Games coming soon!</p>
            </div>
          `;
        }

        // Load rewards data
        const rewardsContent = document.getElementById('rewardsContent');
        
        let rewardsString = '';
        if (user.rewards) {
          // Handle JSON format rewards
          if (user.rewards.startsWith('{') || user.rewards.startsWith('[')) {
            try {
              const rewardsData = JSON.parse(user.rewards);
              rewardsString = rewardsData.rewards || '';
            } catch (e) {
              rewardsString = user.rewards;
            }
          } else {
            rewardsString = user.rewards;
          }
        }
        
        const rewards = rewardsString ? rewardsString.split(',').map(r => r.trim()).filter(r => r) : [];
        
        if (rewards.length > 0) {
          const recentRewards = rewards.slice(-3); // Show last 3 rewards
          
          // Create the HTML more safely to avoid template literal issues
          const rewardsHTML = recentRewards.join(' ');
          rewardsContent.innerHTML = 
            '<div style="font-size: 2rem; margin: 1rem 0;">' + rewardsHTML + '</div>' +
            '<p style="margin: 0; font-size: 0.875rem; color: var(--gray-600);">' +
            rewards.length + ' total reward' + (rewards.length !== 1 ? 's' : '') + ' earned' +
            '</p>' +
            '<a href="reward.html" style="color: var(--orange); text-decoration: none; font-size: 0.875rem;">' +
            'View All Rewards ‚Üí' +
            '</a>';
        } else {
          rewardsContent.innerHTML = 
            '<div style="text-align: center; padding: 1rem;">' +
            '<div style="font-size: 2rem; margin-bottom: 0.5rem;">üéØ</div>' +
            '<p style="color: var(--gray-600); font-style: italic; margin: 0;">' +
            'Complete activities to earn your first rewards!' +
            '</p>' +
            '</div>';
        }

      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Function to fetch real user learning data from Google Sheets
    async function fetchUserLearningData(studentCode) {
      try {
        const response = await fetch(`https://script.google.com/macros/s/AKfycbzwNZGb_nRFF9t4lLdJdbII1kuDKhsiy4_liBxOe3pNc6rWP7swfem33C_ALT3OWQ9GoQ/exec?progress=${encodeURIComponent(studentCode)}`);
        const data = await response.json();
        
        // Calculate real statistics from the data
        const modulesCompleted = data.modules ? data.modules.length : 0;
        let gamesPlayed = 0;
        let totalScore = 0;
        let gameCount = 0;
        
        // Count games from quiz results
        if (data.quizResults && Array.isArray(data.quizResults)) {
          gamesPlayed = data.quizResults.length;
          data.quizResults.forEach(result => {
            if (result.score !== undefined && result.totalQuestions !== undefined) {
              totalScore += (result.score / result.totalQuestions) * 100;
              gameCount++;
            }
          });
        }
        
        // Calculate average score
        const averageScore = gameCount > 0 ? Math.round(totalScore / gameCount) : 0;
        
        // Calculate week progress based on modules and games
        const weekProgress = Math.min(100, Math.round(((modulesCompleted * 20) + (gamesPlayed * 15)) / 2));
        
        return {
          modulesCompleted,
          gamesPlayed,
          averageScore,
          weekProgress
        };
      } catch (error) {
        console.error('Error fetching learning data:', error);
        throw error;
      }
    }

    function showComingSoon() {
      alert('This feature is coming soon! Stay tuned for exciting updates.');
    }
  </script>
</body>
</html>
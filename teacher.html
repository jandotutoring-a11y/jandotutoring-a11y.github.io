<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard – Jando Tutoring</title>
  <link rel="stylesheet" href="shared-styles.css">
  <style>
    /* Modern Teacher Dashboard Styles */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .dashboard-hero {
      background: linear-gradient(135deg, var(--dark-blue) 0%, var(--light-blue) 100%);
      color: white;
      padding: 2rem 0;
      text-align: center;
      margin: 0 0 2rem 0;
      width: 100%;
    }
    
    .dashboard-hero h1 {
      font-size: 2.5rem;
      margin: 0 0 0.5rem 0;
      font-weight: 300;
    }
    
    .dashboard-hero p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin: 0;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--orange);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--dark-blue);
      margin: 0;
    }
    
    .stat-label {
      color: var(--gray-600);
      font-size: 0.9rem;
      margin: 0.5rem 0 0 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-trend {
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
    
    .trend-up { color: #10B981; }
    .trend-down { color: #EF4444; }
    
    .dashboard-section {
      background: white;
      margin: 2rem 0;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .section-header {
      background: linear-gradient(90deg, var(--light-blue), var(--dark-blue));
      color: white;
      padding: 1rem 1.5rem;
      margin: 0;
    }
    
    .section-content {
      padding: 1.5rem;
    }
    
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .student-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.2s ease;
    }
    
    .student-card:hover {
      border-color: var(--light-blue);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .student-name {
      font-weight: bold;
      color: var(--dark-blue);
      margin: 0 0 0.5rem 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 0.5rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange), var(--light-blue));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .controls-modern {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin: 1rem 0;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: border-color 0.2s ease;
    }
    
    .search-box:focus {
      border-color: var(--light-blue);
      outline: none;
      box-shadow: 0 0 0 3px rgba(166, 191, 255, 0.1);
    }
    
    .btn-modern {
      padding: 0.75rem 1.5rem;
      background: var(--orange);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-modern:hover {
      background: var(--secondary-orange-dark);
      transform: translateY(-1px);
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }
    
    .performance-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .badge-excellent { background: #D1FAE5; color: #065F46; }
    .badge-good { background: #DBEAFE; color: #1E40AF; }
    .badge-needs-help { background: #FEF3C7; color: #92400E; }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Access Protection -->
  <script>
    // Immediate access protection - runs before page loads
    (function() {
      // Check if accessed directly (not from a secure link or special parameter)
      const urlParams = new URLSearchParams(window.location.search);
      const hasTeacherAccess = urlParams.get('access') === 'teacher' || 
                               localStorage.getItem('teacherAccess') === 'granted' ||
                               window.location.hash === '#teacher';
      
      if (!hasTeacherAccess) {
        // Redirect to home page immediately
        window.location.href = 'index.html';
        return;
      }
      
      // If they have access, store it temporarily
      localStorage.setItem('teacherAccess', 'granted');
      
      // Remove access after 1 hour for security
      setTimeout(() => {
        localStorage.removeItem('teacherAccess');
      }, 3600000); // 1 hour
    })();
  </script>

  <!-- Authentication Modal -->
  <div id="authModal">
    <div id="authModalContent">
      <h2>Welcome to Jando EDU!</h2>
      <p>Please enter your unique teacher code to access the dashboard.</p>
      <input type="text" id="studentCodeInput" placeholder="Enter your teacher code" maxlength="20">
      <div id="authError" style="display: none; color: var(--accent-red); margin: 0.5rem 0; font-size: 0.875rem;"></div>
      <button id="authLoginBtn" onclick="jandoAuth.authenticateUser()">Login</button>
    </div>
  </div>

  <header>
    <div class="header-content">
      <div class="header-left">
        <div class="logo" style="display: flex; align-items: center; justify-content: center; background: var(--orange); color: white; font-weight: bold; font-size: 1rem;">JE</div>
      </div>
      <div class="header-right">
        <span id="userGreeting" style="display: none;"></span>
        <div class="menu-container">
          <button id="menuBtn" class="menu-button">☰ Menu</button>
          <div id="menuDropdown" class="menu-dropdown">
            <a href="index.html" class="menu-item">Home</a>
            <a href="learning-hub.html" class="menu-item">Learning Hub</a>
            <a href="games.html" class="menu-item">Games</a>
            <a href="reward.html" class="menu-item">My Rewards</a>
            <button class="menu-logout" onclick="jandoAuth.logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Modern Dashboard Hero -->
  <div class="dashboard-hero">
    <h1>Teacher Dashboard</h1>
    <p>Monitor student progress and track learning outcomes</p>
  </div>

  <div class="container">
    <!-- Quick Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalStudents">0</div>
        <div class="stat-label">Total Students</div>
        <div class="stat-trend trend-up" id="studentTrend">+2 this week</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgScore">0%</div>
        <div class="stat-label">Average Score</div>
        <div class="stat-trend trend-up" id="scoreTrend">+5% from last week</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="gamesCompleted">0</div>
        <div class="stat-label">Games Completed</div>
        <div class="stat-trend trend-up" id="gamesTrend">+12 today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeToday">0</div>
        <div class="stat-label">Active Today</div>
        <div class="stat-trend trend-up" id="activeTrend">75% participation</div>
      </div>
    </div>

    <!-- Class Performance Chart -->
    <div class="dashboard-section">
      <h2 class="section-header">Class Performance Overview</h2>
      <div class="section-content">
        <div class="chart-container">
          <canvas id="performanceChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Student Progress Cards -->
    <div class="dashboard-section">
      <h2 class="section-header">Student Progress & Details</h2>
      <div class="section-content">
        <div class="controls-modern">
          <input id="searchAll" type="text" class="search-box" placeholder="Search by student name or ID...">
          <button onclick="loadAll()" class="btn-modern">Load Students</button>
          <span id="allMeta" style="color: var(--gray-600); font-size: 0.9rem;"></span>
        </div>
        
        <!-- Student Search Results -->
        <div id="studentDetailsContainer" style="margin-top: 2rem;">
          <div class="student-grid" id="studentGrid">
            <div style="grid-column: 1/-1; text-align: center; color: var(--gray-600); padding: 2rem; border: 2px dashed #e5e7eb; border-radius: 8px;">
              <p style="font-size: 1.1rem; margin: 0 0 0.5rem 0;">👥 Student Progress Center</p>
              <p style="margin: 0; font-size: 0.9rem;">Click "Load Students" to view all student progress, or search for a specific student above</p>
            </div>
          </div>
        </div>
        
        <!-- Selected Student Details Modal -->
        <div id="studentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 id="modalStudentName" style="margin: 0; color: var(--dark-blue);">Student Details</h3>
              <button onclick="closeStudentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
            </div>
            <div id="modalStudentContent">
              <!-- Student details will be populated here -->
            </div>
          </div>
        </div>
        
        <div id="allError" style="color: var(--accent-red); margin-top: 1rem;"></div>
      </div>
    </div>

    <!-- Game Performance Analysis -->
    <div class="dashboard-section">
      <h2 class="section-header">Game Performance Analysis</h2>
      <div class="section-content">
        <div class="controls-modern">
          <select id="respGameSelect" style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
            <option value="">Select a game to analyze...</option>
          </select>
          <input id="respSearch" type="text" class="search-box" placeholder="Filter by student name...">
          <button onclick="loadResponses()" class="btn-modern">Analyze Game</button>
          <span id="respMeta" style="color: var(--gray-600); font-size: 0.9rem;"></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
          <div>
            <h3 style="color: var(--dark-blue); margin-bottom: 1rem;">Game Statistics</h3>
            <div class="chart-container" style="height: 200px;">
              <canvas id="gameStatsChart"></canvas>
            </div>
          </div>
          <div>
            <h3 style="color: var(--dark-blue); margin-bottom: 1rem;">Response Details</h3>
            <div id="respWrap" style="max-height: 200px; overflow-y: auto;">
              <div style="text-align: center; color: var(--gray-600); padding: 2rem;">
                Select a game and click "Analyze Game" to view detailed responses
              </div>
            </div>
          </div>
        </div>
        <div id="respError" style="color: var(--accent-red); margin-top: 1rem;"></div>
      </div>
    </div>
  </div>


  <script src="auth.js"></script>
  <script>
    // 👉 Your Apps Script web app URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwNZGb_nRFF9t4lLdJdbII1kuDKhsiy4_liBxOe3pNc6rWP7swfem33C_ALT3OWQ9GoQ/exec";

    // Summary elements
    const searchAllEl = document.getElementById('searchAll');
    const allError = document.getElementById('allError');
    const allMeta = document.getElementById('allMeta');

    // Responses elements
    const respSelect = document.getElementById('respGameSelect');
    const respSearchEl = document.getElementById('respSearch');
    const respWrap = document.getElementById('respWrap');
    const respError = document.getElementById('respError');
    const respMeta = document.getElementById('respMeta');
    
    // Chart instances
    let performanceChart = null;
    let gameStatsChart = null;

    // Initialize charts
    function initCharts() {
      // Performance Chart
      const ctx1 = document.getElementById('performanceChart').getContext('2d');
      performanceChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'],
          datasets: [{
            label: 'Number of Students',
            data: [0, 0, 0, 0, 0],
            backgroundColor: ['#EF4444', '#F59E0B', '#EAB308', '#22C55E', '#10B981'],
            borderColor: ['#DC2626', '#D97706', '#CA8A04', '#16A34A', '#059669'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
      
      // Game Stats Chart
      const ctx2 = document.getElementById('gameStatsChart').getContext('2d');
      gameStatsChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Correct', 'Incorrect', 'Unanswered'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#10B981', '#EF4444', '#6B7280']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    // Update performance chart with student data
    function updatePerformanceChart(data) {
      const scoreBands = [0, 0, 0, 0, 0]; // 0-20, 21-40, 41-60, 61-80, 81-100
      
      data.forEach(student => {
        const score = parseFloat(student['Total Score'] || 0);
        if (score <= 20) scoreBands[0]++;
        else if (score <= 40) scoreBands[1]++;
        else if (score <= 60) scoreBands[2]++;
        else if (score <= 80) scoreBands[3]++;
        else scoreBands[4]++;
      });
      
      performanceChart.data.datasets[0].data = scoreBands;
      performanceChart.update();
    }

    // On load: initialize dashboard and populate response game list
    (async function init() {
      // Initialize charts
      initCharts();
      
      try {
        const res = await fetch(`${SCRIPT_URL}?games=list`);
        const games = await res.json();
        if (!Array.isArray(games) || games.length === 0) {
          respSelect.innerHTML = `<option value="">(No games found)</option>`;
        } else {
          // Only include ".Responses" sheets in dropdown
          const respGames = games.filter(g => g.includes(".Responses"));
          respSelect.innerHTML = respGames.map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');
        }
      } catch (err) {
        console.error("Error loading game list", err);
        respSelect.innerHTML = `<option value="">(Error loading games)</option>`;
      }
      
      // Auto-load student data when page loads
      setTimeout(() => {
        loadAll();
      }, 1000);
    })();

    // Load all summary results
    async function loadAll() {
      allError.textContent = '';
      document.getElementById('studentGrid').innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--gray-600); padding: 2rem;">Loading student data...</div>`;
      allMeta.textContent = '';

      try {
        const res = await fetch(`${SCRIPT_URL}?all=true`);
        const data = await res.json();
        
        // Debug: Log the actual data structure
        console.log('Raw Google Sheets data:', data);
        console.log('Sample student data:', data[0]);
        
        const q = searchAllEl.value.trim().toLowerCase();
        const filtered = q ? data.filter(r => {
          const name = String(r.Name || '').toLowerCase();
          const code = String(r.Code || '').toLowerCase();
          const game = String(r.Game || '').toLowerCase();
          return name.includes(q) || code.includes(q) || game.includes(q);
        }) : data;

        // Update statistics
        updateDashboardStats(data);
        
        // Render student cards instead of table
        renderStudentCards(filtered);
        allMeta.textContent = `Showing ${filtered.length} of ${data.length} students`;
        
        // Update performance chart
        updatePerformanceChart(data);
        
      } catch (err) {
        console.error('Error loading student data:', err);
        document.getElementById('studentGrid').innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; color: var(--accent-red); padding: 2rem; border: 2px dashed #ef4444; border-radius: 8px;">
            <p style="font-size: 1.1rem; margin: 0 0 0.5rem 0;">❌ Error Loading Student Data</p>
            <p style="margin: 0; font-size: 0.9rem;">Check console for details. Ensure Google Sheets API is accessible.</p>
            <button onclick="loadAll()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--orange); color: white; border: none; border-radius: 4px; cursor: pointer;">Try Again</button>
          </div>
        `;
        allError.textContent = `Error: ${err.message || 'Failed to load data from Google Sheets'}`;
      }
    }
    
    // Update dashboard statistics
    function updateDashboardStats(data) {
      // Group by unique students (by Name or Code)
      const uniqueStudents = [...new Map(data.map(item => [item.Name || item.Code, item])).values()];
      const totalStudents = uniqueStudents.length;
      
      // Calculate scores from "X/5" format
      const scores = data.map(s => {
        const scoreText = s.Score || '0/5';
        const scoreMatch = String(scoreText).match(/(\d+)\/(\d+)/);
        return scoreMatch ? Math.round((parseInt(scoreMatch[1]) / parseInt(scoreMatch[2])) * 100) : 0;
      }).filter(s => !isNaN(s) && s > 0);
      
      const avgScore = scores.length > 0 ? Math.round(scores.reduce((a,b) => a+b, 0) / scores.length) : 0;
      const gamesCompleted = data.length; // Each row is a completed game
      
      // Calculate active students based on recent activity  
      const today = new Date().toDateString();
      const recentActivity = data.filter(s => {
        if (!s.Date) return false;
        const activityDate = new Date(s.Date).toDateString();
        return activityDate === today;
      }).length;
      
      // Calculate engagement metrics
      const studentsWithProgress = scores.length;
      const engagementRate = totalStudents > 0 ? Math.round((studentsWithProgress / totalStudents) * 100) : 0;
      
      document.getElementById('totalStudents').textContent = totalStudents;
      document.getElementById('avgScore').textContent = avgScore + '%';
      document.getElementById('gamesCompleted').textContent = gamesCompleted;
      document.getElementById('activeToday').textContent = recentActivity;
      
      // Update trend indicators with more meaningful data
      const excellentStudents = scores.filter(s => s >= 80).length;
      const needsSupportStudents = scores.filter(s => s < 60 && s > 0).length;
      
      document.getElementById('studentTrend').textContent = `${excellentStudents} excellent performers`;
      document.getElementById('scoreTrend').textContent = `${engagementRate}% participation rate`;
      document.getElementById('gamesTrend').textContent = `Avg ${Math.round(gamesCompleted / Math.max(totalStudents, 1))} per student`;
      document.getElementById('activeTrend').textContent = `${needsSupportStudents} need support`;
      
      // Update trend colors based on performance
      document.getElementById('studentTrend').className = excellentStudents >= totalStudents * 0.3 ? 'stat-trend trend-up' : 'stat-trend trend-down';
      document.getElementById('scoreTrend').className = avgScore >= 70 ? 'stat-trend trend-up' : 'stat-trend trend-down';
      document.getElementById('activeTrend').className = needsSupportStudents <= totalStudents * 0.2 ? 'stat-trend trend-up' : 'stat-trend trend-down';
    }
    
    // Render student cards
    function renderStudentCards(students) {
      const grid = document.getElementById('studentGrid');
      
      if (!students || students.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; color: var(--gray-600); padding: 2rem; border: 2px dashed #e5e7eb; border-radius: 8px;">
            <p style="font-size: 1.1rem; margin: 0 0 0.5rem 0;">📋 No Student Data Found</p>
            <p style="margin: 0; font-size: 0.9rem;">
              ${students === null || students === undefined ? 'Failed to load data from Google Sheets' : 'No students found matching your search'}
            </p>
          </div>
        `;
        return;
      }
      
      console.log(`Rendering ${students.length} student cards:`, students);
      
      const cardsHTML = students.map((student, index) => {
        // Map the actual Google Sheets fields
        const name = student.Name || 'Unknown Student';
        const code = student.Code || `STU-${index + 1}`;
        let scoreText = student.Score || student['Final Score'] || student['Total Score'] || '0/5';
        
        // Handle "undefined/5" case
        if (String(scoreText).includes('undefined')) {
          scoreText = '0/5';
        }
        
        // Extract numeric score from "X/5" format
        const scoreMatch = String(scoreText).match(/(\d+)\/(\d+)/);
        const totalScore = scoreMatch ? Math.round((parseInt(scoreMatch[1]) / parseInt(scoreMatch[2])) * 100) : 0;
        const game = student.Game || 'Unknown Game';
        const dateStr = student.Date || '';
        const lastActivity = dateStr ? new Date(dateStr).toLocaleDateString() : 'No recent activity';
        const studentId = code;
        const gamesPlayed = 1; // Each row represents one game attempt
        
        // Check for various time field names and add debugging
        const timeSpent = student.Time || student.Duration || student['Time Taken'] || student['Session Time'] || '5 min';
        
        // Debug log for this student
        if (index === 0) {
          console.log(`Debug - Student ${name}:`, {
            Score: student.Score,
            scoreText: scoreText,
            totalScore: totalScore,
            TimeFields: {
              Time: student.Time,
              Duration: student.Duration,
              'Time Taken': student['Time Taken'],
              'Session Time': student['Session Time'],
              finalTimeSpent: timeSpent
            },
            allKeys: Object.keys(student)
          });
        }
        
        const accuracy = totalScore + '%';
        
        let performanceBadge = 'badge-needs-help';
        let performanceText = 'Needs Support';
        let scoreColor = '#EF4444';
        if (totalScore >= 80) {
          performanceBadge = 'badge-excellent';
          performanceText = 'Excellent';
          scoreColor = '#10B981';
        } else if (totalScore >= 60) {
          performanceBadge = 'badge-good';
          performanceText = 'Good Progress';
          scoreColor = '#3B82F6';
        }
        
        return `
          <div class="student-card" style="cursor: pointer; border: 2px solid transparent;" onclick="showStudentDetails(${index})" onmouseover="this.style.borderColor='var(--light-blue)'" onmouseout="this.style.borderColor='transparent'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
              <div>
                <div class="student-name" style="font-size: 1.1rem;">${escapeHtml(name)}</div>
                <div style="font-size: 0.8rem; color: var(--gray-500); margin-top: 0.25rem;">ID: ${escapeHtml(studentId)}</div>
              </div>
              <span class="performance-badge ${performanceBadge}">${performanceText}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
              <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: ${scoreColor};">${totalScore}%</div>
                <div style="font-size: 0.7rem; color: var(--gray-600);">Overall Score</div>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--dark-blue);">${gamesPlayed}</div>
                <div style="font-size: 0.7rem; color: var(--gray-600);">Games Played</div>
              </div>
            </div>
            
            <div class="progress-bar" style="margin-bottom: 0.5rem;">
              <div class="progress-fill" style="width: ${Math.min(totalScore, 100)}%"></div>
            </div>
            
            <!-- Game Performance Indicator -->
            <div style="display: flex; gap: 0.25rem; margin-bottom: 0.5rem; align-items: center;">
              <span style="font-size: 0.8rem; color: var(--gray-600);">Latest Game: ${escapeHtml(game)}</span>
              <div style="flex: 1; height: 6px; background: #E5E7EB; border-radius: 3px; margin-left: 0.5rem;">
                <div style="width: ${Math.min(totalScore, 100)}%; height: 100%; background: ${totalScore >= 80 ? '#10B981' : totalScore >= 60 ? '#3B82F6' : totalScore > 0 ? '#F59E0B' : '#E5E7EB'}; border-radius: 3px;" title="${totalScore}% on ${game}"></div>
              </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--gray-600); margin-top: 0.5rem;">
              <div>
                <div>⏱️ Time: ${escapeHtml(timeSpent)} • 🎯 Accuracy: ${escapeHtml(accuracy)}</div>
                <div style="margin-top: 0.25rem;">📅 Last active: ${escapeHtml(lastActivity)}</div>
              </div>
              <div style="background: var(--light-blue); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">
                Click to view details
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Store students data globally for modal access
      window.studentsData = students;
      
      grid.innerHTML = cardsHTML;
    }
    
    // Generate per-game performance breakdown
    function generateGameBreakdown(student) {
      // Since we have individual game results, show the current game info
      const game = student.Game || 'Unknown Game';
      const scoreText = student.Score || '0/5';
      const scoreMatch = String(scoreText).match(/(\d+)\/(\d+)/);
      const score = scoreMatch ? Math.round((parseInt(scoreMatch[1]) / parseInt(scoreMatch[2])) * 100) : 0;
      const dateStr = student.Date || '';
      const playDate = dateStr ? new Date(dateStr).toLocaleDateString() : 'Unknown date';
      const timeSpent = student.Time || student.Duration || '5 min';
      
      let statusColor = '#EF4444';
      let statusText = 'Needs Practice';
      let bgColor = '#FEF2F2';
      let icon = '🎮';
      
      if (score >= 80) {
        statusColor = '#10B981';
        statusText = 'Excellent!';
        bgColor = '#F0FDF4';
        icon = '⭐';
      } else if (score >= 60) {
        statusColor = '#3B82F6';
        statusText = 'Good Progress';
        bgColor = '#EFF6FF';
        icon = '👍';
      } else if (score > 0) {
        statusColor = '#F59E0B';
        statusText = 'Keep Trying';
        bgColor = '#FFFBEB';
        icon = '📚';
      }
      
      return `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: ${bgColor}; border-radius: 6px; border: 1px solid ${statusColor}20;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.2rem;">${icon}</span>
            <div>
              <div style="font-weight: 600; color: var(--dark-blue); font-size: 0.9rem;">${game}</div>
              <div style="font-size: 0.8rem; color: var(--gray-600);">
                ${playDate} • ${scoreText} • Time: ${timeSpent}
              </div>
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 1.1rem; font-weight: bold; color: ${statusColor};">
              ${score}%
            </div>
            <div style="font-size: 0.7rem; color: ${statusColor}; font-weight: 500;">
              ${statusText}
            </div>
          </div>
        </div>
      `;
    }
    
    // Generate learning insights based on performance data
    function generateLearningInsights(student, totalScore, gamesPlayed) {
      const insights = [];
      
      // Performance level insights
      if (totalScore >= 85) {
        insights.push("🌟 <strong>Excellent performance!</strong> This student demonstrates mastery of the concepts and could benefit from advanced challenges.");
      } else if (totalScore >= 70) {
        insights.push("✅ <strong>Good progress!</strong> This student is on track and showing consistent improvement.");
      } else if (totalScore >= 50) {
        insights.push("📚 <strong>Developing skills:</strong> This student needs additional practice and support to strengthen foundational concepts.");
      } else if (totalScore > 0) {
        insights.push("🎯 <strong>Early stages:</strong> This student requires focused intervention and one-on-one support to build confidence.");
      } else {
        insights.push("🚀 <strong>Getting started:</strong> This student is just beginning their learning journey and needs encouragement to engage with the material.");
      }
      
      // Time-based insights
      const timeSpent = student.Time || student.Duration || '';
      if (timeSpent) {
        const timeMatch = timeSpent.match(/(\d+)/);
        const minutes = timeMatch ? parseInt(timeMatch[1]) : 5;
        
        if (minutes < 3) {
          insights.push("⚡ <strong>Quick completion:</strong> Finished rapidly - may need more challenging content or encourage thorough thinking.");
        } else if (minutes > 10) {
          insights.push("🤔 <strong>Thoughtful approach:</strong> Took time to consider answers - shows careful thinking but may need strategy tips for efficiency.");
        } else {
          insights.push("⏱️ <strong>Good pace:</strong> Completed the activity in a reasonable time frame showing balanced speed and accuracy.");
        }
      }
      
      // Game completion insights
      if (gamesPlayed >= 4) {
        insights.push("🎮 <strong>Highly engaged:</strong> Completed multiple games showing strong commitment to learning.");
      } else if (gamesPlayed >= 2) {
        insights.push("📈 <strong>Making progress:</strong> Good engagement level with steady participation in activities.");
      } else if (gamesPlayed === 1) {
        insights.push("🌱 <strong>Just started:</strong> Recently began participating - encourage continued engagement.");
      } else {
        insights.push("⏰ <strong>Needs encouragement:</strong> Has not yet started activities - may need motivation or technical support.");
      }
      
      // Specific game analysis
      const y6m1Score = parseFloat(student['Y6M.W1.1'] || 0);
      const y6m2Score = parseFloat(student['Y6M.W1.2'] || 0);
      
      if (y6m1Score > 0 && y6m2Score > 0) {
        const improvement = y6m2Score - y6m1Score;
        if (improvement >= 10) {
          insights.push("📊 <strong>Strong improvement:</strong> Shows significant progress between games - learning effectively!");
        } else if (improvement >= 0) {
          insights.push("📊 <strong>Steady progress:</strong> Maintaining consistent performance across different activities.");
        } else {
          insights.push("📊 <strong>Review needed:</strong> Performance declined between games - may need concept reinforcement.");
        }
      }
      
      return insights.join('<br><br>');
    }

    // Show detailed student information in modal
    function showStudentDetails(studentIndex) {
      const student = window.studentsData[studentIndex];
      if (!student) return;
      
      const name = student.Name || 'Unknown Student';
      const scoreText = student.Score || '0/5';
      const scoreMatch = String(scoreText).match(/(\d+)\/(\d+)/);
      const totalScore = scoreMatch ? Math.round((parseInt(scoreMatch[1]) / parseInt(scoreMatch[2])) * 100) : 0;
      const studentId = student.Code || `STU-${studentIndex + 1}`;
      const timeSpent = student.Time || '5 min'; // Get time from data or use default
      const accuracy = totalScore + '%';
      const game = student.Game || 'Unknown Game';
      const dateStr = student.Date || '';
      const lastActivity = dateStr ? new Date(dateStr).toLocaleDateString() : 'No recent activity';
      const joinDate = lastActivity;
      const gamesPlayed = 1; // Each record represents one game played
      
      // Calculate additional metrics
      const avgSessionTime = gamesPlayed > 0 ? Math.round(parseInt(timeSpent.replace(/\D/g, '')) / gamesPlayed) + ' min' : '0 min';
      
      let performanceLevel = 'Needs Support';
      let levelColor = '#EF4444';
      if (totalScore >= 80) {
        performanceLevel = 'Excellent Performance';
        levelColor = '#10B981';
      } else if (totalScore >= 60) {
        performanceLevel = 'Good Progress';
        levelColor = '#3B82F6';
      }
      
      document.getElementById('modalStudentName').textContent = name;
      document.getElementById('modalStudentContent').innerHTML = `
        <div style="display: grid; gap: 1.5rem;">
          <!-- Student Overview -->
          <div style="background: linear-gradient(135deg, var(--light-blue), var(--dark-blue)); color: white; padding: 1.5rem; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
              <div>
                <div style="font-size: 2rem; font-weight: bold;">${totalScore}%</div>
                <div style="opacity: 0.9;">Overall Score</div>
              </div>
              <div>
                <div style="font-size: 2rem; font-weight: bold;">${gamesPlayed}</div>
                <div style="opacity: 0.9;">Games Played</div>
              </div>
              <div>
                <div style="font-size: 2rem; font-weight: bold;">${timeSpent}</div>
                <div style="opacity: 0.9;">Total Time</div>
              </div>
            </div>
          </div>
          
          <!-- Performance Level -->
          <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
            <div style="color: ${levelColor}; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">
              ${performanceLevel}
            </div>
            <div style="color: var(--gray-600);">Current Performance Level</div>
          </div>
          
          <!-- Per-Game Performance Breakdown -->
          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: var(--dark-blue);">🎮 Game Performance Breakdown</h4>
            <div style="display: grid; gap: 0.75rem;">
              ${generateGameBreakdown(student)}
            </div>
          </div>
          
          <!-- Detailed Information -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--dark-blue);">📊 Academic Performance</h4>
              <div style="font-size: 0.9rem; color: var(--gray-600); line-height: 1.5;">
                <div>Overall Score: <strong>${totalScore}%</strong></div>
                <div>Accuracy Rate: <strong>${accuracy}</strong></div>
                <div>Games Completed: <strong>${gamesPlayed}</strong></div>
                <div>Avg Session Time: <strong>${avgSessionTime}</strong></div>
              </div>
            </div>
            
            <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--dark-blue);">📅 Activity Information</h4>
              <div style="font-size: 0.9rem; color: var(--gray-600); line-height: 1.5;">
                <div>Student ID: <strong>${studentId}</strong></div>
                <div>Join Date: <strong>${joinDate}</strong></div>
                <div>Last Activity: <strong>${lastActivity}</strong></div>
                <div>Total Time: <strong>${timeSpent}</strong></div>
              </div>
            </div>
          </div>
          
          <!-- Learning Progress Insights -->
          <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid var(--light-blue);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--dark-blue);">📈 Learning Progress Insights</h4>
            <div style="font-size: 0.9rem; color: var(--gray-700); line-height: 1.5;">
              ${generateLearningInsights(student, totalScore, gamesPlayed)}
            </div>
          </div>
          
          <!-- Recommendations -->
          <div style="padding: 1rem; background: ${totalScore < 60 ? '#FEF3C7' : totalScore < 80 ? '#DBEAFE' : '#D1FAE5'}; border-radius: 8px;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--dark-blue);">💡 Recommendations</h4>
            <div style="font-size: 0.9rem; color: var(--gray-700);">
              ${totalScore < 60 
                ? '• Focus on foundational concepts<br>• Increase practice time<br>• Consider one-on-one support<br>• Review previous game sessions'
                : totalScore < 80 
                ? '• Continue regular practice<br>• Challenge with advanced problems<br>• Track progress weekly<br>• Maintain current momentum'
                : '• Excellent performance! Consider peer tutoring<br>• Try advanced difficulty levels<br>• Maintain consistent practice<br>• Great role model for others'
              }
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('studentModal').style.display = 'block';
    }
    
    // Close student modal
    function closeStudentModal() {
      document.getElementById('studentModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('studentModal');
      if (event.target === modal) {
        closeStudentModal();
      }
    });

    // Load detailed responses
    async function loadResponses() {
      respError.textContent = '';
      respWrap.innerHTML = `<div style="text-align: center; color: var(--gray-600); padding: 1rem;">Loading game data...</div>`;
      respMeta.textContent = '';

      const sel = respSelect.value;
      if (!sel) {
        respWrap.innerHTML = `<div style="text-align: center; color: var(--gray-600); padding: 1rem;">Please select a game to analyze.</div>`;
        return;
      }

      try {
        const res = await fetch(`${SCRIPT_URL}?sheet=${encodeURIComponent(sel)}`);
        const data = await res.json();
        const q = respSearchEl.value.trim().toLowerCase();
        const filtered = q ? data.filter(r => (String(r.Name || '').toLowerCase().includes(q))) : data;

        // Update game statistics chart
        updateGameStatsChart(data);
        
        // Render responses in a more compact format
        renderModernResponses(filtered);
        respMeta.textContent = `Showing ${filtered.length} of ${data.length} responses`;
      } catch (err) {
        console.error(err);
        respWrap.innerHTML = `<div style="text-align: center; color: var(--accent-red); padding: 1rem;">Error loading game data. Please try again.</div>`;
        respError.textContent = 'Error loading responses.';
      }
    }
    
    // Update game statistics chart
    function updateGameStatsChart(data) {
      let correct = 0, incorrect = 0, unanswered = 0;
      
      data.forEach(response => {
        // Look for score or result columns
        const score = response.Score || response.Result || response.Correct;
        if (score === undefined || score === null || score === '') {
          unanswered++;
        } else if (score === 1 || score === '1' || score === true || score === 'Correct') {
          correct++;
        } else {
          incorrect++;
        }
      });
      
      gameStatsChart.data.datasets[0].data = [correct, incorrect, unanswered];
      gameStatsChart.update();
    }
    
    // Render responses in modern format
    function renderModernResponses(responses) {
      if (responses.length === 0) {
        respWrap.innerHTML = `<div style="text-align: center; color: var(--gray-600); padding: 1rem;">No responses found for selected criteria.</div>`;
        return;
      }
      
      const responsesHTML = responses.slice(0, 10).map(resp => { // Show only first 10
        const name = resp.Name || 'Unknown';
        const score = resp.Score || resp.Result || 'N/A';
        const timestamp = resp.Timestamp || resp.Date || 'Unknown';
        
        return `
          <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.8rem;">
            <div style="font-weight: bold; color: var(--dark-blue);">${escapeHtml(name)}</div>
            <div style="color: var(--gray-600);">Score: ${escapeHtml(String(score))} • ${escapeHtml(String(timestamp))}</div>
          </div>
        `;
      }).join('');
      
      const moreText = responses.length > 10 ? `<div style="padding: 0.5rem; text-align: center; color: var(--gray-600); font-size: 0.8rem;">... and ${responses.length - 10} more responses</div>` : '';
      
      respWrap.innerHTML = responsesHTML + moreText;
    }

    // --- TABLE RENDERING ---

    // Summary
    function renderSummaryTable(rows, mount) {
      if (!rows || rows.length === 0) {
        mount.innerHTML = `<div class="empty">No results found.</div>`;
        return;
      }
      const keys = ["Game", "Name", "Code", "Score", "Date", "Time"];
      let html = `<table><thead><tr>${keys.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
      rows.forEach(r => {
        html += `<tr>
          <td>${safe(r.Game)}</td>
          <td>${safe(r.Name)}</td>
          <td>${safe(r.Code)}</td>
          <td>${safe(r.Score)}</td>
          <td>${fmtDateAny(r.Date)}</td>
          <td>${fmtTimeAny(r.Time)}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      mount.innerHTML = html;
    }

    // Responses
    function renderResponsesTable(rows, mount) {
      if (!rows || rows.length === 0) {
        mount.innerHTML = `<div class="empty">No responses found.</div>`;
        return;
      }
      const keys = ["Game","Name","Code","Question","CorrectAnswer","StudentAnswer","Result","Date","Time"];
      let html = `<table><thead><tr>${keys.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
      rows.forEach(r => {
        const resultClass = r.Result === "Correct" ? "correct" : "incorrect";
        html += `<tr>
          <td>${safe(r.Game)}</td>
          <td>${safe(r.Name)}</td>
          <td>${safe(r.Code)}</td>
          <td>${safe(r.Question)}</td>
          <td>${safe(r.CorrectAnswer)}</td>
          <td>${safe(r.StudentAnswer)}</td>
          <td class="${resultClass}">${safe(r.Result)}</td>
          <td>${fmtDateAny(r.Date)}</td>
          <td>${fmtTimeAny(r.Time)}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      mount.innerHTML = html;
    }

    // --- HELPERS ---
    function safe(v) { return escapeHtml(v == null ? "" : String(v)); }

    function fmtDateAny(v) {
      if (!v) return "";
      const s = String(v);
      
      // Check if it's already in DD/MM/YYYY format
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
        const parts = s.split('/');
        // If it looks like MM/DD/YYYY (month > 12), swap to DD/MM/YYYY
        if (parseInt(parts[0]) > 12) {
          return `${parts[1]}/${parts[0]}/${parts[2]}`;
        }
        // If it could be DD/MM/YYYY (both parts <= 12), assume it's correct
        return s;
      }
      
      // Parse any other date format and convert to DD/MM/YYYY
      const d = new Date(s);
      if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }
      return s;
    }

    function fmtTimeAny(v) {
      if (!v) return "";
      const s = String(v);
      if (/^\d{2}:\d{2}$/.test(s)) return s;
      const d = new Date(s);
      if (!isNaN(d)) {
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      }
      return s;
    }

    function escapeHtml(v) {
      // Convert to string first, handle null/undefined
      const str = String(v || '');
      return str
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }
  </script>

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 Jando EDU. All rights reserved. | <a href="https://www.jandotutoring.com/privacy-policy" target="_blank">Privacy Policy</a> | <a href="https://www.jandotutoring.com/contact-us" target="_blank">Contact</a></p>
    </div>
  </footer>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area & Surface Area | Jando EDU</title>
  <link rel="stylesheet" href="shared-styles.css">
  <link rel="stylesheet" href="loading-component.css">
  <link rel="stylesheet" href="auth-component.css">
  <style>
    /* Game specific styles */
    .game-container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--white);
      border-radius: 1rem;
      box-shadow: var(--shadow-lg);
    }

    .game-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, rgba(34, 39, 122, 0.5) 0%, rgba(93, 152, 255, 0.5) 100%), url('images/jando-edu-background.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: var(--white);
      border-radius: 1rem;
    }

    .game-header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.2rem;
      font-weight: var(--font-weight-bold);
    }

    .game-header p {
      margin: 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .question-container {
      background: var(--gray-50);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1.5rem 0;
      border-left: 4px solid var(--orange);
    }

    .question-number {
      color: var(--orange);
      font-weight: var(--font-weight-bold);
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .question-text {
      color: var(--dark-blue);
      font-size: 1.2rem;
      font-weight: var(--font-weight-medium);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    /* Shape diagram styles */
    .shape-diagram {
      text-align: center;
      margin: 1.5rem 0;
      padding: 1rem;
      background: white;
      border-radius: 0.5rem;
      border: 2px solid var(--gray-300);
    }

    .shape-svg {
      max-width: 100%;
      height: auto;
      margin: 1rem 0;
    }

    /* Math formatting */
    .math {
      font-family: 'Times New Roman', serif;
      font-style: italic;
    }

    .superscript {
      vertical-align: super;
      font-size: 0.8em;
    }

    /* Multiple choice options */
    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin: 1rem 0;
    }

    .option {
      background: var(--white);
      border: 2px solid var(--gray-300);
      border-radius: 0.5rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      font-size: 1rem;
    }

    .option:hover {
      border-color: var(--light-blue);
      background: var(--light-blue-50);
    }

    .option.selected {
      border-color: var(--orange);
      background: var(--orange-50);
    }

    .option input[type="radio"] {
      margin-right: 0.75rem;
      width: 16px;
      height: 16px;
      accent-color: var(--orange);
    }

    /* Text input for open response */
    .text-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: var(--font-family);
      margin: 1rem 0;
      transition: border-color 0.3s ease;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--orange);
      box-shadow: 0 0 0 3px rgba(225, 92, 49, 0.1);
    }

    /* Feedback styles */
    .feedback {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-weight: var(--font-weight-medium);
      display: block !important;
      animation: fadeIn 0.3s ease;
      min-height: 20px;
    }

    .feedback.correct {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
      display: block !important;
    }

    .feedback.incorrect {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
      display: block !important;
    }

    .feedback div {
      display: block !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Progress and controls */
    .game-progress {
      background: var(--white);
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 2rem 0;
      text-align: center;
      border: 1px solid var(--gray-300);
    }

    .progress-bar {
      background: var(--gray-200);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--orange) 0%, var(--light-blue) 100%);
      height: 100%;
      transition: width 0.3s ease;
      width: 0%;
    }

    .game-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
    }

    .btn {
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: var(--font-weight-bold);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--orange);
      color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--secondary-orange-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--dark-blue);
      color: var(--white);
      border: 2px solid var(--dark-blue);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--light-blue);
      border-color: var(--light-blue);
      transform: translateY(-1px);
    }

    .btn-secondary:disabled {
      background: var(--gray-300);
      color: var(--gray-600);
      border-color: var(--gray-300);
      opacity: 0.7;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Question submit buttons */
    #textSubmitBtn {
      margin-top: 0.75rem;
      padding: 0.6rem 1.5rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    #textSubmitBtn:disabled {
      background: var(--gray-300);
      color: var(--gray-600);
      cursor: not-allowed;
    }

    #textSubmitBtn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Results screen */
    .results-screen {
      display: none;
      text-align: center;
      padding: 2rem;
    }

    .results-score {
      font-size: 3rem;
      color: var(--orange);
      font-weight: var(--font-weight-bold);
      margin: 1rem 0;
    }

    .results-message {
      font-size: 1.2rem;
      color: var(--dark-blue);
      margin: 1rem 0;
    }

    .results-details {
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: 0.75rem;
      margin: 1.5rem 0;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .options {
        grid-template-columns: 1fr;
      }
      
      .game-container {
        margin: 1rem;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Modal -->
  <div id="authModal">
    <div id="authModalContent">
      <div class="auth-header">
        <img src="images/jando-edu-logo.png" alt="Jando EDU Logo" class="auth-logo">
        <h2>Welcome to Jando EDU!</h2>
        <p>Your learning adventure starts here</p>
      </div>
      
      <div class="auth-body">
        <div class="auth-input-group">
          <label class="auth-input-label" for="studentCodeInput">Student Access Code</label>
          <input type="text" id="studentCodeInput" placeholder="Enter your unique student code" maxlength="20">
        </div>
        
        <div id="authError" style="display: none;"></div>
        
        <button id="authLoginBtn" onclick="jandoAuth.authenticateUser()">
          Login
        </button>
      </div>

      <div class="auth-features">
        <h3>What's waiting for you:</h3>
        <ul class="auth-feature-list">
          <li>
            <div class="auth-feature-icon">ğŸ®</div>
            Interactive games and quizzes
          </li>
          <li>
            <div class="auth-feature-icon">ğŸ“š</div>
            Personalized learning modules
          </li>
          <li>
            <div class="auth-feature-icon">ğŸ†</div>
            Collect rewards and track progress
          </li>
          <li>
            <div class="auth-feature-icon">ğŸ“Š</div>
            Real-time performance insights
          </li>
        </ul>
      </div>
    </div>
  </div>

  <header>
    <div class="header-content">
      <div class="header-left">
        <img src="images/jando-edu-logo.png" alt="Jando EDU Logo" class="logo">
      </div>
      <div class="header-right">
        <span id="userGreeting" style="display: none;"></span>
        <div class="menu-container">
          <button id="menuBtn" class="menu-button">â˜° Menu</button>
          <div id="menuDropdown" class="menu-dropdown">
            <a href="index.html" class="menu-item">Home</a>
            <a href="learning-hub.html" class="menu-item">Learning Hub</a>
            <a href="games.html" class="menu-item">Games</a>
            <a href="reward.html" class="menu-item">My Rewards</a>
            <button class="menu-logout" onclick="jandoAuth.logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="game-container">
    <div class="game-header">
      <h1>ğŸ“ Area & Surface Area</h1>
      <p>Master calculating areas of 2D shapes and surface areas of 3D objects</p>
    </div>

    <div class="game-progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div style="font-size: 0.9rem; color: var(--gray-600); margin-top: 0.5rem;">
        Question <span id="currentQuestion">1</span> of <span id="totalQuestionsDisplay">12</span>
      </div>
    </div>

    <!-- Question Display Area -->
    <div id="questionArea">
      <!-- Questions will be dynamically loaded here -->
    </div>

    <div class="game-controls">
      <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" disabled>Previous</button>
      <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()" disabled>Next Question</button>
      <button id="submitBtn" class="btn btn-primary" onclick="submitGame()" style="display: none;">Submit Test</button>
    </div>

    <!-- Results Screen -->
    <div class="results-screen" id="resultsScreen">
      <h2>ğŸ‰ Test Complete!</h2>
      <div id="firstAttemptScore" style="font-size: 2rem; color: var(--orange); font-weight: bold; margin: 1rem 0; text-align: center;">
        <!-- First attempt score will be inserted here -->
      </div>
      
      <!-- Reward Requirements Info -->
      <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; text-align: center;">
        <div style="font-size: 1rem; color: var(--dark-blue); margin-bottom: 0.5rem;">
          ğŸ† <strong>Reward Requirement</strong>
        </div>
        <div style="font-size: 0.9rem; color: var(--gray-600);">
          Score above 80% to receive rewards and unlock new animals for your collection!
        </div>
      </div>
      
      <div class="results-message" id="resultsMessage"></div>
      <div class="results-details" id="resultsDetails"></div>
      <div class="game-controls">
        <button class="btn btn-primary" onclick="restartGame()">Try Again</button>
        <button class="btn btn-secondary" onclick="window.location.href='games.html'">Back to Games</button>
      </div>
    </div>
  </div>

  <!-- Reward Modal Popup -->
  <div id="rewardModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div id="rewardModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <span class="closeModal" onclick="closeRewardModal()" style="position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: var(--gray-600);">&times;</span>
      <h2 style="color: var(--dark-blue); margin-bottom: 10px;">ğŸ‰ Congratulations! ğŸ‰</h2>
      <p id="rewardMessage" style="font-size: 20px; margin-bottom: 20px;">Click the present to reveal your reward!</p>
      <div id="rewardDisplay" onclick="revealReward()" style="cursor: pointer; font-size: 4rem; margin: 1rem 0; transition: transform 0.3s ease;">ğŸ</div>
      <div style="display: none; text-align: center; margin-top: 25px;" id="rewardButtons">
        <button onclick="closeRewardModal()" style="margin: 0 1.5rem; padding: 1rem 2rem; background: var(--light-blue); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 16px; transition: transform 0.2s;">Awesome!</button>
        <button onclick="window.location.href='games.html'" style="background: var(--orange); color: white; border: none; padding: 1rem 2rem; border-radius: 0.75rem; cursor: pointer; font-weight: 600; margin: 0 1.5rem; font-size: 16px; transition: transform 0.2s;">ğŸ  Return to Games</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 Jando EDU. All rights reserved. | <a href="https://www.jandotutoring.com/privacy-policy" target="_blank">Privacy Policy</a> | <a href="https://www.jandotutoring.com/contact-us" target="_blank">Contact</a></p>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script src="loading-component.js"></script>
  <script>
    // Game state
    let currentQuestionIndex = 0;
    let score = 0;
    let userAnswers = [];
    let submittedTextAnswers = [];
    let gameCompleted = false;

    // ğŸ¾ All animals for rewards
    const animals = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®",
      "ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ¦†","ğŸ¦…","ğŸ¦‰","ğŸ´","ğŸ¦„","ğŸ","ğŸ›","ğŸ¦‹",
      "ğŸŒ","ğŸ","ğŸ¢","ğŸ","ğŸ¦","ğŸ¦–","ğŸ¦•","ğŸ™","ğŸ¦‘","ğŸ¦","ğŸ¦","ğŸ¦€","ğŸ¡","ğŸ ","ğŸŸ",
      "ğŸ¬","ğŸ³","ğŸ‹","ğŸ¦ˆ","ğŸŠ","ğŸ…","ğŸ†","ğŸ¦“","ğŸ¦","ğŸ¦§","ğŸ˜","ğŸ¦›","ğŸ¦","ğŸª","ğŸ«",
      "ğŸ¦’","ğŸ¦˜","ğŸƒ","ğŸ‚","ğŸ„","ğŸ","ğŸ–","ğŸ","ğŸ‘","ğŸ","ğŸ¦Œ","ğŸ•","ğŸ©","ğŸˆ","ğŸ“",
      "ğŸ¦ƒ","ğŸ•Šï¸","ğŸ‡","ğŸ","ğŸ€","ğŸ¿ï¸","ğŸ¦”"];

    let currentReward = "";

    // Question data with diagrams
    const questions = [
      // Rectangle Area Questions (1-3)
      {
        type: 'multiple-choice',
        question: 'Find the area of a rectangle with length 8 cm and width 5 cm.',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="200" height="120" viewBox="0 0 200 120">
              <rect x="20" y="20" width="160" height="80" fill="lightblue" stroke="black" stroke-width="2"/>
              <text x="100" y="65" text-anchor="middle" font-size="14" fill="black">Rectangle</text>
              <text x="100" y="15" text-anchor="middle" font-size="12" fill="black">8 cm</text>
              <text x="10" y="65" text-anchor="middle" font-size="12" fill="black" transform="rotate(-90, 10, 65)">5 cm</text>
            </svg>
          </div>
        `,
        options: ['26 cmÂ²', '40 cmÂ²', '13 cmÂ²', '80 cmÂ²'],
        correct: 1,
        correctAnswer: '40 cmÂ²',
        correctFeedback: 'Correct! Area of rectangle = length Ã— width = 8 Ã— 5 = 40 cmÂ².',
        incorrectFeedback: 'Remember: Area of rectangle = length Ã— width. Try 8 Ã— 5.'
      },
      {
        type: 'multiple-choice',
        question: 'What is the area of a square with side length 6 m?',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="150" height="150" viewBox="0 0 150 150">
              <rect x="25" y="25" width="100" height="100" fill="lightgreen" stroke="black" stroke-width="2"/>
              <text x="75" y="80" text-anchor="middle" font-size="14" fill="black">Square</text>
              <text x="75" y="15" text-anchor="middle" font-size="12" fill="black">6 m</text>
              <text x="15" y="75" text-anchor="middle" font-size="12" fill="black" transform="rotate(-90, 15, 75)">6 m</text>
            </svg>
          </div>
        `,
        options: ['24 mÂ²', '12 mÂ²', '36 mÂ²', '18 mÂ²'],
        correct: 2,
        correctAnswer: '36 mÂ²',
        correctFeedback: 'Excellent! Area of square = sideÂ² = 6Â² = 36 mÂ².',
        incorrectFeedback: 'For a square, area = side Ã— side = sideÂ². Try 6Â².'
      },
      {
        type: 'text-response',
        question: 'A rectangular garden has an area of 72 mÂ² and a width of 8 m. What is the length?',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="220" height="120" viewBox="0 0 220 120">
              <rect x="20" y="30" width="180" height="60" fill="lightcoral" stroke="black" stroke-width="2"/>
              <text x="110" y="65" text-anchor="middle" font-size="14" fill="black">Garden</text>
              <text x="110" y="25" text-anchor="middle" font-size="12" fill="black">? m</text>
              <text x="10" y="65" text-anchor="middle" font-size="12" fill="black" transform="rotate(-90, 10, 65)">8 m</text>
              <text x="110" y="110" text-anchor="middle" font-size="12" fill="black">Area = 72 mÂ²</text>
            </svg>
          </div>
        `,
        acceptedAnswers: ['9', '9 m', '9m', '9 metres', '9 meters'],
        correctFeedback: 'Perfect! Length = Area Ã· width = 72 Ã· 8 = 9 m.',
        incorrectFeedback: 'Use the formula: Area = length Ã— width, so length = Area Ã· width.'
      },

      // Triangle Area Questions (4-6)
      {
        type: 'multiple-choice',
        question: 'Find the area of a triangle with base 10 cm and height 6 cm.',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="200" height="160" viewBox="0 0 200 160">
              <polygon points="50,120 150,120 100,40" fill="lightyellow" stroke="black" stroke-width="2"/>
              <line x1="100" y1="40" x2="100" y2="120" stroke="red" stroke-width="1" stroke-dasharray="3,3"/>
              <text x="100" y="20" text-anchor="middle" font-size="14" fill="black">Triangle</text>
              <text x="100" y="140" text-anchor="middle" font-size="12" fill="black">10 cm</text>
              <text x="115" y="80" text-anchor="start" font-size="12" fill="red">6 cm</text>
            </svg>
          </div>
        `,
        options: ['60 cmÂ²', '16 cmÂ²', '20 cmÂ²', '30 cmÂ²'],
        correct: 3,
        correctAnswer: '30 cmÂ²',
        correctFeedback: 'Correct! Area of triangle = Â½ Ã— base Ã— height = Â½ Ã— 10 Ã— 6 = 30 cmÂ².',
        incorrectFeedback: 'Remember: Area of triangle = Â½ Ã— base Ã— height. Try Â½ Ã— 10 Ã— 6.'
      },
      {
        type: 'text-response',
        question: 'A triangle has an area of 24 cmÂ² and a base of 8 cm. What is its height?',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="200" height="160" viewBox="0 0 200 160">
              <polygon points="50,130 150,130 100,70" fill="lightpink" stroke="black" stroke-width="2"/>
              <line x1="100" y1="70" x2="100" y2="130" stroke="red" stroke-width="1" stroke-dasharray="3,3"/>
              <text x="100" y="50" text-anchor="middle" font-size="14" fill="black">Triangle</text>
              <text x="100" y="150" text-anchor="middle" font-size="12" fill="black">8 cm</text>
              <text x="115" y="100" text-anchor="start" font-size="12" fill="red">? cm</text>
              <text x="100" y="20" text-anchor="middle" font-size="12" fill="black">Area = 24 cmÂ²</text>
            </svg>
          </div>
        `,
        acceptedAnswers: ['6', '6 cm', '6cm', '6 centimetres', '6 centimeters'],
        correctFeedback: 'Excellent! Height = (2 Ã— Area) Ã· base = (2 Ã— 24) Ã· 8 = 6 cm.',
        incorrectFeedback: 'Use: Area = Â½ Ã— base Ã— height, so height = (2 Ã— Area) Ã· base.'
      },

      // Circle Area Questions (7-8)
      {
        type: 'multiple-choice',
        question: 'Find the area of a circle with radius 4 cm. (Use Ï€ â‰ˆ 3.14)',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="180" height="200" viewBox="0 0 180 200">
              <circle cx="90" cy="100" r="60" fill="lightsteelblue" stroke="black" stroke-width="2"/>
              <line x1="90" y1="100" x2="150" y2="100" stroke="red" stroke-width="2"/>
              <text x="90" y="25" text-anchor="middle" font-size="14" fill="black">Circle</text>
              <text x="120" y="85" text-anchor="middle" font-size="12" fill="red">4 cm</text>
            </svg>
          </div>
        `,
        options: ['25.12 cmÂ²', '50.24 cmÂ²', '12.56 cmÂ²', '100.48 cmÂ²'],
        correct: 1,
        correctAnswer: '50.24 cmÂ²',
        correctFeedback: 'Perfect! Area of circle = Ï€rÂ² = 3.14 Ã— 4Â² = 3.14 Ã— 16 = 50.24 cmÂ².',
        incorrectFeedback: 'Use the formula: Area = Ï€rÂ². With r = 4, try Ï€ Ã— 4Â².'
      },

      // Surface Area - Rectangular Prism (9-10)
      {
        type: 'multiple-choice',
        question: 'Find the surface area of a rectangular prism with length 5 cm, width 3 cm, and height 4 cm.',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="250" height="180" viewBox="0 0 250 180">
              <!-- 3D rectangular prism -->
              <polygon points="30,60 30,140 120,140 120,60" fill="lightblue" stroke="black" stroke-width="2"/>
              <polygon points="120,60 120,140 200,120 200,40" fill="lightcyan" stroke="black" stroke-width="2"/>
              <polygon points="30,60 120,60 200,40 110,40" fill="lightsteelblue" stroke="black" stroke-width="2"/>
              <text x="75" y="105" text-anchor="middle" font-size="12" fill="black">3 cm</text>
              <text x="160" y="85" text-anchor="middle" font-size="12" fill="black">5 cm</text>
              <text x="25" y="100" text-anchor="middle" font-size="12" fill="black" transform="rotate(-90, 25, 100)">4 cm</text>
              <text x="125" y="170" text-anchor="middle" font-size="14" fill="black">Rectangular Prism</text>
            </svg>
          </div>
        `,
        options: ['60 cmÂ²', '47 cmÂ²', '94 cmÂ²', '120 cmÂ²'],
        correct: 2,
        correctAnswer: '94 cmÂ²',
        correctFeedback: 'Correct! Surface Area = 2(lw + lh + wh) = 2(5Ã—3 + 5Ã—4 + 3Ã—4) = 2(15 + 20 + 12) = 94 cmÂ².',
        incorrectFeedback: 'Use SA = 2(lw + lh + wh). Calculate each face area and multiply by 2.'
      },
      {
        type: 'text-response',
        question: 'A cube has a surface area of 96 cmÂ². What is the length of each edge?',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="200" height="180" viewBox="0 0 200 180">
              <!-- 3D cube with proper proportions -->
              <polygon points="50,80 50,130 100,130 100,80" fill="lightgreen" stroke="black" stroke-width="2"/>
              <polygon points="100,80 100,130 130,110 130,60" fill="lightseagreen" stroke="black" stroke-width="2"/>
              <polygon points="50,80 100,80 130,60 80,60" fill="mediumseagreen" stroke="black" stroke-width="2"/>
              <text x="75" y="110" text-anchor="middle" font-size="12" fill="black">? cm</text>
              <text x="100" y="170" text-anchor="middle" font-size="14" fill="black">Cube</text>
              <text x="100" y="25" text-anchor="middle" font-size="12" fill="black">Surface Area = 96 cmÂ²</text>
            </svg>
          </div>
        `,
        acceptedAnswers: ['4', '4 cm', '4cm', '4 centimetres', '4 centimeters'],
        correctFeedback: 'Excellent! For a cube: SA = 6sÂ², so sÂ² = 96 Ã· 6 = 16, therefore s = 4 cm.',
        incorrectFeedback: 'For a cube, Surface Area = 6sÂ². Find s when 6sÂ² = 96.'
      },

      // Cylinder Surface Area (11-12)
      {
        type: 'multiple-choice',
        question: 'Find the surface area of a cylinder with radius 3 cm and height 8 cm. (Use Ï€ â‰ˆ 3.14)',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="200" height="200" viewBox="0 0 200 200">
              <!-- Cylinder -->
              <ellipse cx="100" cy="50" rx="50" ry="15" fill="lightcoral" stroke="black" stroke-width="2"/>
              <rect x="50" y="50" width="100" height="100" fill="lightpink" stroke="black" stroke-width="2"/>
              <ellipse cx="100" cy="150" rx="50" ry="15" fill="lightcoral" stroke="black" stroke-width="2"/>
              <line x1="100" y1="50" x2="100" y2="150" stroke="red" stroke-width="1" stroke-dasharray="3,3"/>
              <line x1="100" y1="50" x2="150" y2="50" stroke="blue" stroke-width="2"/>
              <text x="125" y="45" text-anchor="middle" font-size="12" fill="blue">3 cm</text>
              <text x="110" y="105" text-anchor="start" font-size="12" fill="red">8 cm</text>
              <text x="100" y="185" text-anchor="middle" font-size="14" fill="black">Cylinder</text>
            </svg>
          </div>
        `,
        options: ['150.72 cmÂ²', '75.36 cmÂ²', '282.6 cmÂ²', '207.24 cmÂ²'],
        correct: 3,
        correctAnswer: '207.24 cmÂ²',
        correctFeedback: 'Perfect! SA = 2Ï€rÂ² + 2Ï€rh = 2Ï€(3Â²) + 2Ï€(3)(8) = 18Ï€ + 48Ï€ = 66Ï€ â‰ˆ 207.24 cmÂ².',
        incorrectFeedback: 'Use SA = 2Ï€rÂ² + 2Ï€rh. Calculate the area of both circles plus the curved surface.'
      },
      {
        type: 'text-response',
        question: 'A cylinder has a radius of 5 cm and surface area of 314 cmÂ². What is its height? (Use Ï€ â‰ˆ 3.14)',
        diagram: `
          <div class="shape-diagram">
            <svg class="shape-svg" width="200" height="200" viewBox="0 0 200 200">
              <!-- Cylinder with unknown height -->
              <ellipse cx="100" cy="60" rx="50" ry="15" fill="lightyellow" stroke="black" stroke-width="2"/>
              <rect x="50" y="60" width="100" height="80" fill="lightgoldenrodyellow" stroke="black" stroke-width="2"/>
              <ellipse cx="100" cy="140" rx="50" ry="15" fill="lightyellow" stroke="black" stroke-width="2"/>
              <line x1="100" y1="60" x2="100" y2="140" stroke="red" stroke-width="1" stroke-dasharray="3,3"/>
              <line x1="100" y1="60" x2="150" y2="60" stroke="blue" stroke-width="2"/>
              <text x="125" y="55" text-anchor="middle" font-size="12" fill="blue">5 cm</text>
              <text x="110" y="105" text-anchor="start" font-size="12" fill="red">? cm</text>
              <text x="100" y="175" text-anchor="middle" font-size="14" fill="black">Cylinder</text>
              <text x="100" y="25" text-anchor="middle" font-size="12" fill="black">SA = 314 cmÂ²</text>
            </svg>
          </div>
        `,
        acceptedAnswers: ['5', '5 cm', '5cm', '5 centimetres', '5 centimeters'],
        correctFeedback: 'Excellent! SA = 2Ï€rÂ² + 2Ï€rh, so 314 = 2Ï€(25) + 2Ï€(5)h. Solving: h = 5 cm.',
        incorrectFeedback: 'Use SA = 2Ï€rÂ² + 2Ï€rh. Substitute known values and solve for h.'
      }
    ];

    // Fisher-Yates shuffle algorithm
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Randomize multiple choice options
    function randomizeQuestions() {
      questions.forEach(question => {
        if (question.type === 'multiple-choice') {
          const correctAnswer = question.options[question.correct];
          const shuffledOptions = shuffleArray(question.options);
          const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);
          
          question.options = shuffledOptions;
          question.correct = newCorrectIndex;
          
          console.log(`Question randomized: "${question.question.substring(0, 30)}..." - Correct answer now at position ${newCorrectIndex + 1}`);
        }
      });
      console.log('ğŸ² All multiple choice questions have been randomized!');
    }

    // Initialize game
    document.addEventListener('DOMContentLoaded', function() {
      const checkAuth = setInterval(() => {
        if (window.jandoAuth && jandoAuth.isAuthenticated()) {
          clearInterval(checkAuth);
          setTimeout(() => {
            jandoLoading.showDuring(initializeGame, 1500);
          }, 500);
        }
      }, 100);

      window.addEventListener('jandoAuthComplete', (event) => {
        setTimeout(() => {
          jandoLoading.showDuring(initializeGame, 1500);
        }, 500);
      });
    });

    function initializeGame() {
      randomizeQuestions(); // Shuffle options before starting
      updateTotalQuestions();
      displayQuestion();
      updateProgress();
    }

    function updateTotalQuestions() {
      const totalQuestionsElement = document.getElementById('totalQuestionsDisplay');
      if (totalQuestionsElement) {
        totalQuestionsElement.textContent = questions.length;
      }
    }

    function displayQuestion() {
      const question = questions[currentQuestionIndex];
      const questionArea = document.getElementById('questionArea');
      
      let html = `
        <div class="question-container">
          <div class="question-number">Question ${currentQuestionIndex + 1}</div>
          <div class="question-text">${formatMath(question.question)}</div>
          ${question.diagram || ''}
      `;

      if (question.type === 'multiple-choice') {
        html += '<div class="options">';
        question.options.forEach((option, index) => {
          const isSelected = userAnswers[currentQuestionIndex] === index;
          html += `
            <div class="option ${isSelected ? 'selected' : ''}" onclick="selectOption(${index})">
              <input type="radio" name="q${currentQuestionIndex}" ${isSelected ? 'checked' : ''}>
              ${formatMath(option)}
            </div>
          `;
        });
        html += '</div>';
      } else {
        const userAnswer = userAnswers[currentQuestionIndex] || '';
        html += `
          <input type="text" class="text-input" id="textInput${currentQuestionIndex}" 
                 placeholder="Enter your answer..." value="${userAnswer}"
                 onkeyup="handleTextInput(event)" oninput="updateTextAnswer()">
          <button class="btn btn-primary" onclick="submitTextAnswer()" id="textSubmitBtn" ${userAnswer ? '' : 'disabled'}>
            Submit Answer
          </button>
        `;
      }

      html += '<div class="feedback" id="feedback"></div>';
      html += '</div>';
      
      questionArea.innerHTML = html;
      
      updateNavigationButtons();
    }

    function formatMath(text) {
      let formatted = text.replace(/\^2/g, '<span class="superscript">2</span>')
                          .replace(/\^3/g, '<span class="superscript">3</span>')
                          .replace(/Ï€/g, 'Ï€')
                          .replace(/â‰ˆ/g, 'â‰ˆ')
                          .replace(/Ã·/g, 'Ã·')
                          .replace(/Ã—/g, 'Ã—');
      return formatted;
    }

    function selectOption(optionIndex) {
      if (!window.firstAttempts) window.firstAttempts = {};
      
      const questionKey = `q${currentQuestionIndex}`;
      
      if (!window.firstAttempts[questionKey]) {
        const question = questions[currentQuestionIndex];
        const isCorrectFirst = optionIndex === question.correct;
        
        window.firstAttempts[questionKey] = {
          question: question.question,
          selectedAnswer: question.options[optionIndex],
          correctAnswer: question.options[question.correct],
          isCorrect: isCorrectFirst,
          timestamp: new Date().toISOString()
        };
        
        console.log(`ğŸ”’ FIRST ATTEMPT LOCKED for Question ${currentQuestionIndex + 1}:`, {
          selected: question.options[optionIndex],
          correct: question.options[question.correct],
          wasCorrect: isCorrectFirst
        });
      } else {
        console.log(`ğŸ“ Subsequent attempt for Question ${currentQuestionIndex + 1} (first attempt already locked: "${window.firstAttempts[questionKey].selectedAnswer}")`);
      }
      
      userAnswers[currentQuestionIndex] = optionIndex;
      
      document.querySelectorAll('.option').forEach((opt, idx) => {
        opt.classList.remove('selected');
        const radio = opt.querySelector('input[type="radio"]');
        radio.checked = idx === optionIndex;
      });
      
      const selectedOption = document.querySelectorAll('.option')[optionIndex];
      selectedOption.classList.add('selected');
      
      const question = questions[currentQuestionIndex];
      const isCurrentCorrect = optionIndex === question.correct;
      const feedbackElement = document.getElementById('feedback');
      
      if (isCurrentCorrect) {
        feedbackElement.className = 'feedback correct';
        feedbackElement.textContent = question.correctFeedback;
      } else {
        feedbackElement.className = 'feedback incorrect';
        feedbackElement.textContent = question.incorrectFeedback;
      }
      
      feedbackElement.style.display = 'block';
      updateNavigationButtons();
    }

    function handleTextInput(event) {
      if (event.key === 'Enter') {
        submitTextAnswer();
      } else {
        updateTextAnswer();
      }
    }

    function updateTextAnswer() {
      const input = document.getElementById(`textInput${currentQuestionIndex}`);
      if (input) {
        const value = input.value.trim();
        userAnswers[currentQuestionIndex] = value;
        
        const submitBtn = document.getElementById('textSubmitBtn');
        if (submitBtn) {
          submitBtn.disabled = !value;
        }
        
        updateNavigationButtons();
      }
    }

    function submitTextAnswer() {
      const input = document.getElementById(`textInput${currentQuestionIndex}`);
      if (input && input.value.trim()) {
        const value = input.value.trim();
        
        if (!window.firstAttempts) window.firstAttempts = {};
        
        const questionKey = `q${currentQuestionIndex}`;
        
        if (!window.firstAttempts[questionKey]) {
          const question = questions[currentQuestionIndex];
          const acceptableAnswers = question.acceptedAnswers;
          const isCorrectFirst = acceptableAnswers.some(answer => 
            answer.toLowerCase().trim() === value.toLowerCase().trim()
          );
          
          window.firstAttempts[questionKey] = {
            question: question.question,
            selectedAnswer: value,
            correctAnswer: acceptableAnswers[0],
            acceptableAnswers: acceptableAnswers,
            isCorrect: isCorrectFirst,
            timestamp: new Date().toISOString()
          };
          
          console.log(`ğŸ”’ FIRST ATTEMPT LOCKED for Question ${currentQuestionIndex + 1}:`, {
            answer: value,
            correctOptions: acceptableAnswers,
            wasCorrect: isCorrectFirst
          });
        } else {
          console.log(`ğŸ“ Subsequent attempt for Question ${currentQuestionIndex + 1} (first attempt already locked: "${window.firstAttempts[questionKey].selectedAnswer}")`);
        }
        
        updateTextAnswer();
        checkAnswer();
        
        submittedTextAnswers[currentQuestionIndex] = true;
        
        const feedback = document.getElementById('feedback');
        if (feedback) {
          feedback.style.display = 'block';
        }
        
        updateNavigationButtons();
        
        const question = questions[currentQuestionIndex];
        if (question.type === 'text-response') {
          const normalizedUserAnswer = value.toLowerCase().replace(/\s/g, '');
          const isCorrect = question.acceptedAnswers.some(answer => 
            answer.toLowerCase().replace(/\s/g, '') === normalizedUserAnswer
          );
          
          feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
          feedback.textContent = isCorrect ? question.correctFeedback : question.incorrectFeedback;
          feedback.style.display = 'block';
        }
        
        const submitBtn = document.getElementById('textSubmitBtn');
        if (submitBtn) {
          submitBtn.textContent = 'Submitted âœ“';
          submitBtn.style.background = 'var(--light-blue)';
          setTimeout(() => {
            submitBtn.textContent = 'Submit Answer';
            submitBtn.style.background = 'var(--orange)';
          }, 1000);
        }
      }
    }

    function checkAnswer() {
      const question = questions[currentQuestionIndex];
      const feedback = document.getElementById('feedback');
      const userAnswer = userAnswers[currentQuestionIndex];
      
      if (userAnswer === undefined || userAnswer === '') return;
      
      let isCorrect = false;
      
      if (question.type === 'multiple-choice') {
        isCorrect = userAnswer === question.correct;
      } else {
        const normalizedUserAnswer = userAnswer.toLowerCase().replace(/\s/g, '');
        isCorrect = question.acceptedAnswers.some(answer => 
          answer.toLowerCase().replace(/\s/g, '') === normalizedUserAnswer
        );
      }
      
      feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
      feedback.textContent = isCorrect ? question.correctFeedback : question.incorrectFeedback;
      feedback.style.display = 'block';
      
      if (!userAnswers[`scored_${currentQuestionIndex}`]) {
        if (isCorrect) {
          score++;
        }
        userAnswers[`scored_${currentQuestionIndex}`] = true;
      }
    }

    function updateProgress() {
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      prevBtn.disabled = currentQuestionIndex === 0;
      
      const hasAnswer = userAnswers[currentQuestionIndex] !== undefined && userAnswers[currentQuestionIndex] !== '';
      const currentQuestion = questions[currentQuestionIndex];
      
      let canProceed = hasAnswer;
      if (currentQuestion && currentQuestion.type === 'text-response') {
        canProceed = hasAnswer && submittedTextAnswers[currentQuestionIndex] === true;
      }
      
      nextBtn.disabled = !canProceed;
      
      if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = canProceed ? 'inline-block' : 'none';
      } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
        updateProgress();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1 && userAnswers[currentQuestionIndex] !== undefined) {
        currentQuestionIndex++;
        displayQuestion();
        updateProgress();
      }
    }

    async function submitGame() {
      if (gameCompleted) return;
      
      gameCompleted = true;
      jandoLoading.show();
      
      if (!window.firstAttempts) window.firstAttempts = {};
      
      let firstAttemptScore = 0;
      const firstAttemptResponses = [];
      let currentScore = 0;
      const currentResponses = [];
      
      questions.forEach((question, index) => {
        const questionKey = `q${index}`;
        const firstAttempt = window.firstAttempts[questionKey];
        const currentAnswer = userAnswers[index];
        
        let currentIsCorrect = false;
        if (question.type === 'multiple-choice') {
          currentIsCorrect = currentAnswer === question.correct;
        } else {
          if (currentAnswer) {
            const normalizedCurrent = currentAnswer.toLowerCase().replace(/\s/g, '');
            currentIsCorrect = question.acceptedAnswers.some(answer => 
              answer.toLowerCase().replace(/\s/g, '') === normalizedCurrent
            );
          }
        }
        
        if (currentIsCorrect) currentScore++;
        
        // Create response record for first attempt (for scoring purposes)
        if (firstAttempt) {
          if (firstAttempt.isCorrect) firstAttemptScore++;
          
          firstAttemptResponses.push({
            question: question.question,
            answer: firstAttempt.selectedAnswer,
            correct: firstAttempt.correctAnswer
          });
        } else {
          // If no first attempt recorded, use current answer as first attempt
          console.warn(`No first attempt recorded for question ${index + 1}, using current answer`);
          if (currentIsCorrect) firstAttemptScore++;
          
          firstAttemptResponses.push({
            question: question.question,
            answer: question.type === 'multiple-choice' ? 
              (question.options[currentAnswer] || 'No answer') : 
              (currentAnswer || 'No answer'),
            correct: question.type === 'multiple-choice' ? 
              question.options[question.correct] : 
              question.acceptedAnswers[0]
          });
        }
        
        currentResponses.push({
          question: question.question,
          userAnswer: question.type === 'multiple-choice' ? 
            (question.options[currentAnswer] || 'No answer') : 
            (currentAnswer || 'No answer'),
          correctAnswer: question.type === 'multiple-choice' ? 
            question.options[question.correct] : 
            question.acceptedAnswers[0],
          isCorrect: currentIsCorrect,
          firstAttemptCorrect: firstAttempt ? firstAttempt.isCorrect : currentIsCorrect
        });
      });
      
      console.log(`ğŸ“Š SUBMISSION SUMMARY:
        First Attempt Score: ${firstAttemptScore}/${questions.length}
        Current Score: ${currentScore}/${questions.length}
        Percentage: ${Math.round((firstAttemptScore / questions.length) * 100)}%
        Qualifies for reward: ${firstAttemptScore >= (questions.length * 0.8) ? 'YES' : 'NO'}`);
      
      // Debug: Show detailed first attempt results
      firstAttemptResponses.forEach((response, index) => {
        console.log(`Q${index + 1}: "${response.answer}" vs "${response.correct}" = ${response.answer === response.correct ? 'CORRECT' : 'INCORRECT'}`);
      });
      
      await saveGameResults(firstAttemptScore, firstAttemptResponses);
      
      jandoLoading.complete();
      
      setTimeout(() => {
        jandoLoading.hide();
        showResults(currentScore, currentResponses);
      }, 500);
    }

    async function saveGameResults(finalScore, responses) {
      if (!jandoAuth.isAuthenticated()) {
        console.log('User not authenticated, skipping save');
        return;
      }

      const user = jandoAuth.getCurrentUser();
      
      // Format the score for the sheet (e.g., "8/12")
      const scoreString = `${finalScore}/${questions.length}`;
      
      const gameData = {
        code: user.code,
        game: 'Y9M.W2.1 - Area & Surface Area',
        score: Number(finalScore), // Ensure it's a number
        totalQuestions: Number(questions.length), // Ensure it's a number
        sheet: 'Y9M.W2.1_AreaSurfaceArea',
        responses: responses
      };
      
      console.log('Sending game data:', gameData);

      try {
        // Save main game results
        const response = await fetch('https://script.google.com/macros/s/AKfycbzwNZGb_nRFF9t4lLdJdbII1kuDKhsiy4_liBxOe3pNc6rWP7swfem33C_ALT3OWQ9GoQ/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(gameData)
        });
        
        console.log('Game results sent to Google Sheets');
        
        // Award reward if score is 80% or higher
        if (finalScore >= (questions.length * 0.8)) {
          console.log('Score qualifies for reward, processing...');
          await awardReward(user.code);
        }
        
      } catch (error) {
        console.error('Error saving game results:', error);
        console.log('Continuing with local results display...');
      }
    }

    async function awardReward(studentCode) {
      try {
        // Get a random animal reward
        const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
        
        // Send reward to Google Sheets
        const rewardData = {
          code: studentCode,
          reward: randomAnimal
        };
        
        const response = await fetch('https://script.google.com/macros/s/AKfycbzwNZGb_nRFF9t4lLdJdbII1kuDKhsiy4_liBxOe3pNc6rWP7swfem33C_ALT3OWQ9GoQ/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(rewardData)
        });
        
        // Set the reward for display
        currentReward = randomAnimal;
        console.log('Reward awarded:', randomAnimal);
        
      } catch (error) {
        console.error('Error awarding reward:', error);
      }
    }

    function showResults(finalScore, responses) {
      document.getElementById('questionArea').style.display = 'none';
      document.querySelector('.game-controls').style.display = 'none';
      
      const resultsScreen = document.getElementById('resultsScreen');
      const percentage = Math.round((finalScore / questions.length) * 100);
      
      const firstAttemptCount = responses.filter(r => r.firstAttemptCorrect).length;
      const firstAttemptPercentage = Math.round((firstAttemptCount / questions.length) * 100);
      
      document.getElementById('firstAttemptScore').innerHTML = `
        <div style="font-size: 1.2rem; color: var(--dark-blue); margin-bottom: 0.5rem;">Score</div>
        <div style="font-size: 2.5rem; color: var(--orange); font-weight: bold;">${firstAttemptCount}/${questions.length}</div>
      `;
      
      let message = '';
      if (percentage >= 90) {
        message = 'ğŸŒŸ Outstanding! You have mastered area and surface area!';
      } else if (percentage >= 80) {
        message = 'ğŸ‰ Excellent work! You have a strong grasp of geometry!';
      } else if (percentage >= 70) {
        message = 'ğŸ‘ Good job! Keep practicing to improve further!';
      } else if (percentage >= 60) {
        message = 'ğŸ“š You\'re getting there! Review the concepts and try again!';
      } else {
        message = 'ğŸ”„ Keep practicing! Review area and surface area formulas.';
      }
      
      document.getElementById('resultsMessage').textContent = message;
      
      if (firstAttemptCount !== finalScore) {
        const improvementMessage = `
          <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
            <strong>Great improvement!</strong> You improved from ${firstAttemptCount} to ${finalScore} correct answers through practice!
          </div>
        `;
        document.getElementById('resultsMessage').innerHTML += improvementMessage;
      }
      
      const correctCount = responses.filter(r => r.isCorrect).length;
      const incorrectCount = responses.length - correctCount;
      
      document.getElementById('resultsDetails').innerHTML = `
        <p><strong>Correct:</strong> ${correctCount}</p>
        <p><strong>Incorrect:</strong> ${incorrectCount}</p>
        <p><strong>Percentage:</strong> ${percentage}%</p>
      `;
      
      resultsScreen.style.display = 'block';
      
      if (percentage >= 80) {
        setTimeout(() => {
          giveReward();
        }, 1000);
      } else {
        setTimeout(() => {
          showReturnHomeButton();
        }, 1000);
      }
    }

    function showReturnHomeButton() {
      if (document.querySelector('.return-home-btn')) return;
      
      const returnBtn = document.createElement('button');
      returnBtn.className = 'return-home-btn';
      returnBtn.innerHTML = 'ğŸ  Return to Games';
      returnBtn.style.cssText = `
        background: var(--light-blue);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 0.75rem;
        cursor: pointer;
        font-weight: 600;
        margin: 1rem;
        font-size: 16px;
        transition: all 0.3s ease;
      `;
      returnBtn.onmouseover = () => returnBtn.style.transform = 'translateY(-2px)';
      returnBtn.onmouseout = () => returnBtn.style.transform = 'translateY(0)';
      returnBtn.onclick = () => window.location.href = 'games.html';
      
      document.getElementById('resultsScreen').appendChild(returnBtn);
    }

    function giveReward() {
      if (!jandoAuth.isAuthenticated()) {
        console.log('User not authenticated, cannot give reward');
        showReturnHomeButton();
        return;
      }

      // If we already have a reward from the saveGameResults function, show it
      if (currentReward) {
        console.log('Showing reward that was already awarded:', currentReward);
        document.getElementById("rewardModal").style.display = "block";
        return;
      }

      // Fallback: fetch rewards from Google Sheets if currentReward is not set
      const user = jandoAuth.getCurrentUser();
      const scriptURL = 'https://script.google.com/macros/s/AKfycbzwNZGb_nRFF9t4lLdJdbII1kuDKhsiy4_liBxOe3pNc6rWP7swfem33C_ALT3OWQ9GoQ/exec';
      
      fetch(scriptURL + "?rewards=" + encodeURIComponent(user.code))
        .then(response => response.text())
        .then(data => {
          console.log('Reward response:', data);
          
          if (data.includes('ERROR') || data.includes('Error')) {
            console.error('Error getting reward:', data);
            showReturnHomeButton();
            return;
          }
          
          try {
            const rewardData = JSON.parse(data);
            if (rewardData.rewards && rewardData.rewards.length > 0) {
              // Get the last (most recent) reward
              const rewardList = rewardData.rewards.split(',');
              currentReward = rewardList[rewardList.length - 1].trim();
              document.getElementById("rewardModal").style.display = "block";
            } else {
              console.log('No reward data found');
              showReturnHomeButton();
            }
          } catch (e) {
            // Try parsing as simple text response
            const cleanData = data.trim();
            if (animals.includes(cleanData)) {
              currentReward = cleanData;
              document.getElementById("rewardModal").style.display = "block";
            } else {
              console.error('Error parsing reward:', e);
              console.log('Raw response:', data);
              showReturnHomeButton();
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showReturnHomeButton();
        });
    }
    
    function revealReward() {
      document.getElementById("rewardDisplay").innerText = currentReward;
      document.getElementById("rewardDisplay").style.animation = "wiggle 1s infinite";
      document.getElementById("rewardMessage").innerText = "ğŸ‰ You earned a new animal friend! ğŸ‰";
      document.getElementById("rewardButtons").style.display = "block";
      
      document.getElementById("rewardDisplay").onclick = null;
      document.getElementById("rewardDisplay").style.cursor = "default";
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
          confetti.style.backgroundColor = ['#ff6b35', '#f7931e', '#ffd700', '#32cd32', '#00bfff'][Math.floor(Math.random() * 5)];
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }, i * 30);
      }
    }
    
    function closeRewardModal() {
      document.getElementById("rewardModal").style.display = "none";
      document.getElementById("rewardDisplay").onclick = revealReward;
      document.getElementById("rewardDisplay").style.cursor = "pointer";
      document.getElementById("rewardDisplay").style.animation = "";
      
      showReturnHomeButton();
    }
    
    window.onclick = function(event) {
      let modal = document.getElementById("rewardModal");
      if (event.target === modal) {
        closeRewardModal();
      }
    }

    function restartGame() {
      currentQuestionIndex = 0;
      score = 0;
      userAnswers = [];
      submittedTextAnswers = [];
      gameCompleted = false;
      window.firstAttempts = {}; // Clear first attempts
      
      document.getElementById('questionArea').style.display = 'block';
      document.querySelector('.game-controls').style.display = 'flex';
      document.getElementById('resultsScreen').style.display = 'none';
      jandoLoading.hide();
      
      randomizeQuestions(); // Randomize again for new attempt
      displayQuestion();
      updateProgress();
    }
  </script>
</body>
</html>
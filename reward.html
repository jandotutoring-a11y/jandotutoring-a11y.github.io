<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Rewards Dashboard</title>
  <link rel="stylesheet" href="shared-styles.css">
  <style>
    /* All common styles are now in shared-styles.css */
    /* Reward emoji animations */
    .reward-emoji {
      display: inline-block;
      margin: 0.5rem;
      font-size: 4rem;
      padding: 0.25rem;
      transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      cursor: pointer;
      user-select: none;
      position: relative;
      transform-origin: center;
    }
    
    .reward-emoji:hover {
      transform: scale(1.2) rotate(5deg);
      animation: bounce 0.6s ease-in-out;
      filter: brightness(1.2) drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
    }
    
    .reward-emoji:active {
      animation: celebrate 3s ease-in-out; /* Even slower at 3 seconds */
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: scale(1.2) translateY(0) rotate(5deg); }
      40% { transform: scale(1.3) translateY(-10px) rotate(-5deg); }
      60% { transform: scale(1.25) translateY(-5px) rotate(3deg); }
    }
    
    @keyframes celebrate {
      0% { transform: scale(1.2) rotate(0deg); }
      25% { transform: scale(1.5) rotate(90deg); }
      50% { transform: scale(1.8) rotate(180deg); }
      75% { transform: scale(1.6) rotate(270deg); }
      100% { transform: scale(1.2) rotate(360deg); } /* Only one full rotation instead of two */
    }
    
    /* Confetti styles */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      border-radius: 50%; /* Add this to make it round */
      pointer-events: none;
      z-index: 10000;
    }
    
    @keyframes confetti-fall {
      0% { 
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% { 
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* Welcome section styles */
    .welcome-section {
      background: linear-gradient(135deg, var(--light-blue) 0%, var(--dark-blue) 100%);
      color: var(--white);
      padding: 3rem 0;
      text-align: center;
      margin: 0 0 2rem 0;
      width: 100%;
    }

    .welcome-section h1 {
      font-size: 2.5rem;
      margin: 0 0 1rem 0;
      font-weight: var(--font-weight-bold);
    }

    .welcome-section p {
      font-size: 1.2rem;
      margin: 0;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <!-- Authentication Modal -->
  <div id="authModal">
    <div id="authModalContent">
      <h2>Welcome to Jando EDU!</h2>
      <p>Please enter your unique student code to access your games and track your progress.</p>
      <input type="text" id="studentCodeInput" placeholder="Enter your student code" maxlength="20">
      <div id="authError" style="display: none; color: var(--accent-red); margin: 0.5rem 0; font-size: 0.875rem;"></div>
      <button id="authLoginBtn" onclick="jandoAuth.authenticateUser()">Login</button>
    </div>
  </div>

  <header>
    <div class="header-content">
      <div class="header-left">
        <img src="https://i.imgur.com/QIdMEsB.png" alt="Jando EDU Logo" class="logo">
      </div>
      <div class="header-right">
        <span id="userGreeting" style="display: none;"></span>
        <div class="menu-container">
          <button id="menuBtn" class="menu-button">☰ Menu</button>
          <div id="menuDropdown" class="menu-dropdown">
            <a href="index.html" class="menu-item">Home</a>
            <a href="learning-hub.html" class="menu-item">Learning Hub</a>
            <a href="games.html" class="menu-item">Games</a>
            <a href="reward.html" class="menu-item">My Rewards</a>
            <button class="menu-logout" onclick="jandoAuth.logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="welcome-section">
    <h1>Your Amazing Rewards!</h1>
    <p>Celebrate your achievements and keep collecting</p>
  </div>

  <div class="container">
    <div id="rewardArea">
      <p><strong>Keep up the great work! Here are the rewards you've earned:</strong></p>
      <div id="rewardsGrid" style="font-size: 3rem; text-align: center; margin: 2rem 0;">
        <div style="color: var(--gray-600); font-size: 1rem;">Loading your rewards...</div>
      </div>
      <button onclick="loadRewards()" style="margin-top: 1rem; padding: 0.5rem 1rem;">🔄 Refresh Rewards</button>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    // Load rewards when user is authenticated
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, starting auth check');
      
      const checkAuth = setInterval(() => {
        console.log('Checking auth... jandoAuth exists:', !!window.jandoAuth, 'authenticated:', window.jandoAuth ? jandoAuth.isAuthenticated() : 'N/A');
        
        if (window.jandoAuth && jandoAuth.isAuthenticated()) {
          console.log('Auth confirmed, loading rewards');
          loadRewards();
          clearInterval(checkAuth);
        }
      }, 100);
      
      // Listen for auth completion to refresh rewards
      window.addEventListener('jandoAuthComplete', (event) => {
        console.log('Auth completion event received:', event.detail);
        setTimeout(() => {
          console.log('Calling loadRewards from auth completion event');
          loadRewards();
        }, 100); // Small delay to ensure everything is ready
      });
    });

    function loadRewards() {
      console.log('loadRewards called');
      const user = jandoAuth.getCurrentUser();
      console.log('User data:', user);
      
      if (!user) {
        console.log('No user found, exiting loadRewards');
        return;
      }

      const rewardsGrid = document.getElementById("rewardsGrid");
      console.log('Rewards grid element:', rewardsGrid);
      
      console.log('User rewards data:', user.rewards);
      
      let rewardsString = '';
      
      // Handle different reward data formats
      if (user.rewards && user.rewards.trim()) {
        // Check if it's JSON format
        if (user.rewards.startsWith('{') || user.rewards.startsWith('[')) {
          try {
            const rewardsData = JSON.parse(user.rewards);
            rewardsString = rewardsData.rewards || '';
            console.log('Parsed JSON rewards data:', rewardsData, 'extracted rewards:', rewardsString);
          } catch (e) {
            console.log('Failed to parse JSON rewards, treating as string:', e);
            rewardsString = user.rewards;
          }
        } else {
          rewardsString = user.rewards;
        }
        
        const rewards = rewardsString.split(',').map(r => r.trim()).filter(r => r);
        console.log('Final parsed rewards:', rewards);
        
        if (rewards.length > 0) {
          const rewardsHTML = rewards.map((reward, index) => 
            `<span class="reward-emoji" onclick="createConfetti(event)" data-emoji="${reward.trim()}">${reward.trim()}</span>`
          ).join('');
          
          rewardsGrid.innerHTML = rewardsHTML;
          
          // Ensure visibility (keep the essential fixes)
          const container = document.querySelector('.container');
          const rewardArea = document.getElementById('rewardArea');
          
          if (container) {
            container.style.visibility = 'visible';
            container.style.display = 'block';
            container.style.opacity = '1';
          }
          
          if (rewardArea) {
            rewardArea.style.visibility = 'visible';
            rewardArea.style.display = 'block';
            rewardArea.style.opacity = '1';
          }
          
          rewardsGrid.style.visibility = 'visible';
          rewardsGrid.style.display = 'block';
          rewardsGrid.style.opacity = '1';
        } else {
          rewardsGrid.innerHTML = `
            <div style="color: var(--gray-600); font-size: 1.2rem; margin: 2rem 0;">
              <p>🎮 No rewards yet - start playing games to earn some!</p>
              <a href="games.html" style="color: var(--orange); text-decoration: none; font-weight: bold;">
                → Play Games Now
              </a>
            </div>
          `;
        }
      } else {
        rewardsGrid.innerHTML = `
          <div style="color: var(--gray-600); font-size: 1.2rem; margin: 2rem 0;">
            <p>🎮 No rewards yet - start playing games to earn some!</p>
            <a href="games.html" style="color: var(--orange); text-decoration: none; font-weight: bold;">
              → Play Games Now
            </a>
          </div>
        `;
      }
      
      // Show refresh message (only when called from button, not on initial load)
      if (arguments[0] === 'manual') {
        showRefreshMessage();
      }
    }

    function showRefreshMessage() {
      // Remove existing message if it exists
      const existingMessage = document.getElementById('refreshMessage');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // Create and show new message
      const message = document.createElement('div');
      message.id = 'refreshMessage';
      message.innerHTML = '✅ Rewards refreshed!';
      message.style.cssText = `
        color: #32CD32;
        font-size: 1rem;
        margin-top: 0.5rem;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      
      // Insert after the refresh button
      const refreshButton = document.querySelector('button[onclick="loadRewards()"]');
      refreshButton.parentNode.insertBefore(message, refreshButton.nextSibling);
      
      // Fade in
      setTimeout(() => message.style.opacity = '1', 10);
      
      // Fade out and remove after 3 seconds
      setTimeout(() => {
        message.style.opacity = '0';
        setTimeout(() => {
          if (message.parentNode) {
            message.parentNode.removeChild(message);
          }
        }, 300);
      }, 3000);
    }
    
    // Confetti animation function
    function createConfetti(event) {
      const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF'];
      const emojis = ['🎉', '⭐', '✨', '🌟', '💫', '🎊'];
      
      // Get click position
      const rect = event.target.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      // Create multiple confetti pieces
      for (let i = 0; i < 25; i++) {
        createConfettiPiece(centerX, centerY, colors[Math.floor(Math.random() * colors.length)], emojis[Math.floor(Math.random() * emojis.length)]);
      }
      
      // Play a fun sound effect (if you want to add audio later)
      // new Audio('celebration.mp3').play().catch(() => {});
    }
    
    function createConfettiPiece(x, y, color, emoji) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.innerHTML = ''; // Remove content to make it a solid circle
      confetti.style.left = x + (Math.random() - 0.5) * 100 + 'px';
      confetti.style.top = y + 'px';
      confetti.style.backgroundColor = color; // Use background color instead of text color
      confetti.style.fontSize = (Math.random() * 10 + 8) + 'px';
      confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
      
      document.body.appendChild(confetti);
      
      // Remove confetti after animation
      setTimeout(() => {
        if (confetti.parentNode) {
          confetti.parentNode.removeChild(confetti);
        }
      }, 5000);
    }
  </script>

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 Jando EDU. All rights reserved. | <a href="https://www.jandotutoring.com/privacy-policy" target="_blank">Privacy Policy</a> | <a href="https://www.jandotutoring.com/contact-us" target="_blank">Contact</a></p>
    </div>
  </footer>
</body>
</html>

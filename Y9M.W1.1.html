<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Algebra Fundamentals | Jando EDU</title>
  <link rel="stylesheet" href="shared-styles.css">
  <link rel="stylesheet" href="loading-component.css">
  <link rel="stylesheet" href="auth-component.css">
  <style>
    /* Game specific styles */
    .game-container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--white);
      border-radius: 1rem;
      box-shadow: var(--shadow-lg);
    }

    .game-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, var(--dark-blue) 0%, var(--light-blue) 100%);
      color: var(--white);
      border-radius: 1rem;
    }

    .game-header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.2rem;
      font-weight: var(--font-weight-bold);
    }

    .game-header p {
      margin: 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .question-container {
      background: var(--gray-50);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1.5rem 0;
      border-left: 4px solid var(--orange);
    }

    .question-number {
      color: var(--orange);
      font-weight: var(--font-weight-bold);
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .question-text {
      color: var(--dark-blue);
      font-size: 1.2rem;
      font-weight: var(--font-weight-medium);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    /* Math formatting */
    .math {
      font-family: 'Times New Roman', serif;
      font-style: italic;
    }

    .superscript {
      vertical-align: super;
      font-size: 0.8em;
    }

    /* Fraction styling */
    .fraction {
      display: inline-block;
      vertical-align: middle;
      text-align: center;
      font-family: 'Times New Roman', serif;
      margin: 0 0.2em;
    }

    .fraction .numerator {
      display: block;
      border-bottom: 1px solid var(--dark-blue);
      padding: 0 0.3em 0.1em 0.3em;
      font-size: 1em;
      line-height: 1.2;
    }

    .fraction .denominator {
      display: block;
      padding: 0.1em 0.3em 0 0.3em;
      font-size: 1em;
      line-height: 1.2;
    }

    /* Ensure fractions look good in different contexts */
    .question-text .fraction {
      font-size: 1.1em;
    }

    .option .fraction {
      font-size: 1em;
    }

    /* Multiple choice options */
    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin: 1rem 0;
    }

    .option {
      background: var(--white);
      border: 2px solid var(--gray-300);
      border-radius: 0.5rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      font-size: 1rem;
    }

    .option:hover {
      border-color: var(--light-blue);
      background: var(--light-blue-50);
    }

    .option.selected {
      border-color: var(--orange);
      background: var(--orange-50);
    }

    .option input[type="radio"] {
      margin-right: 0.75rem;
      width: 16px;
      height: 16px;
      accent-color: var(--orange);
    }

    /* Text input for open response */
    .text-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: var(--font-family);
      margin: 1rem 0;
      transition: border-color 0.3s ease;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--orange);
      box-shadow: 0 0 0 3px rgba(225, 92, 49, 0.1);
    }

    /* Feedback styles */
    .feedback {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-weight: var(--font-weight-medium);
      display: block !important;
      animation: fadeIn 0.3s ease;
      min-height: 20px;
    }

    .feedback.correct {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
      display: block !important;
    }

    .feedback.incorrect {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
      display: block !important;
    }

    /* Ensure feedback content is visible */
    .feedback div {
      display: block !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Progress and controls */
    .game-progress {
      background: var(--white);
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 2rem 0;
      text-align: center;
      border: 1px solid var(--gray-300);
    }

    .progress-bar {
      background: var(--gray-200);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--orange) 0%, var(--light-blue) 100%);
      height: 100%;
      transition: width 0.3s ease;
      width: 0%;
    }

    .score-display {
      font-size: 1.1rem;
      color: var(--dark-blue);
      font-weight: var(--font-weight-medium);
      margin: 0.5rem 0;
    }

    .game-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
    }

    .btn {
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: var(--font-weight-bold);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--orange);
      color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--secondary-orange-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--dark-blue);
      color: var(--white);
      border: 2px solid var(--dark-blue);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--light-blue);
      border-color: var(--light-blue);
      transform: translateY(-1px);
    }

    .btn-secondary:disabled {
      background: var(--gray-300);
      color: var(--gray-600);
      border-color: var(--gray-300);
      opacity: 0.7;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Question submit buttons */
    #textSubmitBtn {
      margin-top: 0.75rem;
      padding: 0.6rem 1.5rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    #textSubmitBtn:disabled {
      background: var(--gray-300);
      color: var(--gray-600);
      cursor: not-allowed;
    }

    #textSubmitBtn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Reward Modal Styles */
    .closeModal:hover {
      color: var(--accent-red);
    }

    #rewardDisplay:hover {
      transform: scale(1.1);
    }

    /* Reward button hover effects */
    #rewardButtons button:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }

    /* Confetti Animation */
    @keyframes confetti-fall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--orange);
      animation: confetti-fall linear;
      z-index: 999;
    }

    /* Wiggle animation for reward */
    @keyframes wiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
    }



    /* Results screen */
    .results-screen {
      display: none;
      text-align: center;
      padding: 2rem;
    }

    .results-score {
      font-size: 3rem;
      color: var(--orange);
      font-weight: var(--font-weight-bold);
      margin: 1rem 0;
    }

    .results-message {
      font-size: 1.2rem;
      color: var(--dark-blue);
      margin: 1rem 0;
    }

    .results-details {
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: 0.75rem;
      margin: 1.5rem 0;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .options {
        grid-template-columns: 1fr;
      }
      
      .game-container {
        margin: 1rem;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Modal -->
  <div id="authModal">
    <div id="authModalContent">
      <div class="auth-header">
        <img src="https://i.imgur.com/QIdMEsB.png" alt="Jando EDU Logo" class="auth-logo">
        <h2>Welcome to Jando EDU!</h2>
        <p>Your learning adventure starts here</p>
      </div>
      
      <div class="auth-body">
        <div class="auth-input-group">
          <label class="auth-input-label" for="studentCodeInput">Student Access Code</label>
          <input type="text" id="studentCodeInput" placeholder="Enter your unique student code" maxlength="20">
        </div>
        
        <div id="authError" style="display: none;"></div>
        
        <button id="authLoginBtn" onclick="jandoAuth.authenticateUser()">
          Login
        </button>
      </div>

      <div class="auth-features">
        <h3>What's waiting for you:</h3>
        <ul class="auth-feature-list">
          <li>
            <div class="auth-feature-icon">🎮</div>
            Interactive games and quizzes
          </li>
          <li>
            <div class="auth-feature-icon">📚</div>
            Personalized learning modules
          </li>
          <li>
            <div class="auth-feature-icon">🏆</div>
            Collect rewards and track progress
          </li>
          <li>
            <div class="auth-feature-icon">📊</div>
            Real-time performance insights
          </li>
        </ul>
      </div>
    </div>
  </div>

  <header>
    <div class="header-content">
      <div class="header-left">
        <img src="https://i.imgur.com/QIdMEsB.png" alt="Jando EDU Logo" class="logo">
      </div>
      <div class="header-right">
        <span id="userGreeting" style="display: none;"></span>
        <div class="menu-container">
          <button id="menuBtn" class="menu-button">☰ Menu</button>
          <div id="menuDropdown" class="menu-dropdown">
            <a href="index.html" class="menu-item">Home</a>
            <a href="learning-hub.html" class="menu-item">Learning Hub</a>
            <a href="games.html" class="menu-item">Games</a>
            <a href="reward.html" class="menu-item">My Rewards</a>
            <button class="menu-logout" onclick="jandoAuth.logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="game-container">
    <div class="game-header">
      <h1>🔢 Algebra Fundamentals</h1>
      <p>Master the basics of algebraic expressions, factoring, and equation solving</p>
    </div>

    <div class="game-progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div style="font-size: 0.9rem; color: var(--gray-600); margin-top: 0.5rem;">
        Question <span id="currentQuestion">1</span> of <span id="totalQuestionsDisplay">15</span>
      </div>
    </div>

    <!-- Question Display Area -->
    <div id="questionArea">
      <!-- Questions will be dynamically loaded here -->
    </div>

    <div class="game-controls">
      <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" disabled>Previous</button>
      <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()" disabled>Next Question</button>
      <button id="submitBtn" class="btn btn-primary" onclick="submitGame()" style="display: none;">Submit Test</button>
    </div>

    <!-- Loading Screen Component will be injected here -->

    <!-- Results Screen -->
    <div class="results-screen" id="resultsScreen">
      <h2>🎉 Test Complete!</h2>
      <div id="firstAttemptScore" style="font-size: 2rem; color: var(--orange); font-weight: bold; margin: 1rem 0; text-align: center;">
        <!-- First attempt score will be inserted here -->
      </div>
      
      <!-- Reward Requirements Info -->
      <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; text-align: center;">
        <div style="font-size: 1rem; color: var(--dark-blue); margin-bottom: 0.5rem;">
          🏆 <strong>Reward Requirement</strong>
        </div>
        <div style="font-size: 0.9rem; color: var(--gray-600);">
          Score above 80% to receive rewards and unlock new animals for your collection!
        </div>
      </div>
      
      <div class="results-message" id="resultsMessage"></div>
      <div class="results-details" id="resultsDetails"></div>
      <div class="game-controls">
        <button class="btn btn-primary" onclick="restartGame()">Try Again</button>
        <button class="btn btn-secondary" onclick="window.location.href='games.html'">Back to Games</button>
      </div>
    </div>
  </div>

  <!-- Reward Modal Popup -->
  <div id="rewardModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div id="rewardModalContent" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <span class="closeModal" onclick="closeRewardModal()" style="position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: var(--gray-600);">&times;</span>
      <h2 style="color: var(--dark-blue); margin-bottom: 10px;">🎉 Congratulations! 🎉</h2>
      <p id="rewardMessage" style="font-size: 20px; margin-bottom: 20px;">Click the present to reveal your reward!</p>
      <div id="rewardDisplay" onclick="revealReward()" style="cursor: pointer; font-size: 4rem; margin: 1rem 0; transition: transform 0.3s ease;">🎁</div>
      <div style="display: none; text-align: center; margin-top: 25px;" id="rewardButtons">
        <button onclick="closeRewardModal()" style="margin: 0 1.5rem; padding: 1rem 2rem; background: var(--light-blue); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 16px; transition: transform 0.2s;">Awesome!</button>
        <button onclick="window.location.href='games.html'" style="background: var(--orange); color: white; border: none; padding: 1rem 2rem; border-radius: 0.75rem; cursor: pointer; font-weight: 600; margin: 0 1.5rem; font-size: 16px; transition: transform 0.2s;">🏠 Return to Games</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 Jando EDU. All rights reserved. | <a href="https://www.jandotutoring.com/privacy-policy" target="_blank">Privacy Policy</a> | <a href="https://www.jandotutoring.com/contact-us" target="_blank">Contact</a></p>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script src="loading-component.js"></script>
  <script>
    // Game state
    let currentQuestionIndex = 0;
    let score = 0;
    let userAnswers = [];
    let submittedTextAnswers = []; // Track which text questions have been submitted
    let gameCompleted = false;

    // 🐾 All animals for rewards
    const animals = ["🐶","🐱","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮",
      "🐷","🐸","🐵","🐔","🐧","🐦","🐤","🦆","🦅","🦉","🐴","🦄","🐝","🐛","🦋",
      "🐌","🐞","🐢","🐍","🦎","🦖","🦕","🐙","🦑","🦐","🦞","🦀","🐡","🐠","🐟",
      "🐬","🐳","🐋","🦈","🐊","🐅","🐆","🦓","🦍","🦧","🐘","🦛","🦏","🐪","🐫",
      "🦒","🦘","🐃","🐂","🐄","🐎","🐖","🐏","🐑","🐐","🦌","🐕","🐩","🐈","🐓",
      "🦃","🕊️","🐇","🐁","🐀","🐿️","🦔"];

    let currentReward = ""; // Store the current reward

    // Question data
    const questions = [
      // Multiple Choice Questions (1-8)
      {
        type: 'multiple-choice',
        question: 'Expand and simplify: 2(x + 3)',
        options: ['2x + 6', '2x + 3', 'x + 6', '2x - 3'],
        correct: 0,
        correctAnswer: '2x + 6',
        correctFeedback: 'Well done! Multiply each term by 2: 2 × x + 2 × 3 = 2x + 6.',
        incorrectFeedback: 'Check your multiplication; remember to multiply both x and 3 by 2.'
      },
      {
        type: 'multiple-choice',
        question: 'Expand: (x + 2)(x - 5)',
        options: ['x² - 10', 'x² + 2x - 5x - 10', 'x² - 3x - 10', 'x² + 3x - 10'],
        correct: 2,
        correctAnswer: 'x² - 3x - 10',
        correctFeedback: 'Excellent! Expand and combine like terms: x² - 3x - 10.',
        incorrectFeedback: 'Multiply each term carefully and combine like terms.'
      },
      {
        type: 'multiple-choice',
        question: 'Factorise: x² + 6x + 9',
        options: ['(x + 3)²', '(x + 5)(x + 1)', '(x + 9)(x + 1)', 'x(x + 9)'],
        correct: 0,
        correctAnswer: '(x + 3)²',
        correctFeedback: 'Great! This is a perfect square trinomial: (x + 3)².',
        incorrectFeedback: 'Look for two identical factors that add to 6 and multiply to 9.'
      },
      {
        type: 'multiple-choice',
        question: 'Factorise: y² - 16',
        options: ['(y - 8)(y + 2)', '(y + 4)(y - 4)', '(y + 8)(y - 2)', 'y(y - 16)'],
        correct: 1,
        correctAnswer: '(y + 4)(y - 4)',
        correctFeedback: 'Well done! It\'s a difference of squares: (y + 4)(y - 4).',
        incorrectFeedback: 'Use the formula: a² - b² = (a + b)(a - b).'
      },
      {
        type: 'multiple-choice',
        question: 'Solve for x: 2x + 7 = 17',
        options: ['x = 12', 'x = 5', 'x = 10', 'x = 7'],
        correct: 1,
        correctAnswer: 'x = 5',
        correctFeedback: 'Correct! 2x = 10, so x = 5.',
        incorrectFeedback: 'Subtract 7 first, then divide by 2.'
      },
      {
        type: 'multiple-choice',
        question: 'Solve for y: 4y - 2 = 10',
        options: ['y = 2', 'y = 3', 'y = 4', 'y = 8'],
        correct: 1,
        correctAnswer: 'y = 3',
        correctFeedback: 'Great! 4y = 12, so y = 3.',
        incorrectFeedback: 'Add 2 first, then divide by 4.'
      },
      {
        type: 'multiple-choice',
        question: 'Solve for a: 7a = 28',
        options: ['a = 4', 'a = 7', 'a = 21', 'a = 35'],
        correct: 0,
        correctAnswer: 'a = 4',
        correctFeedback: 'Correct! Divide both sides by 7: a = 4.',
        incorrectFeedback: 'Divide 28 by 7 to find a.'
      },
      {
        type: 'multiple-choice',
        question: 'A number multiplied by 6 equals 42. What is the number?',
        options: ['6', '7', '42', '48'],
        correct: 1,
        correctAnswer: '7',
        correctFeedback: 'Excellent! 6 × 7 = 42.',
        incorrectFeedback: 'Divide 42 by 6 to get the number.'
      },

      // Text Response Questions (9-15)
      {
        type: 'text-response',
        question: 'Expand and simplify: 3(a - 4) + 2(a + 1)',
        acceptedAnswers: ['5a - 10', '5a-10', '-10 + 5a', '-10+5a'],
        correctAnswer: '5a - 10',
        correctFeedback: 'Well done! 3a - 12 + 2a + 2 = 5a - 10.',
        incorrectFeedback: 'Multiply each bracket, then combine like terms.'
      },
      {
        type: 'text-response',
        question: 'Factorise: 5x + 15',
        acceptedAnswers: ['5(x + 3)', '5(x+3)', '(x + 3)5', '(x+3)5', '5*(x+3)', '5*(x + 3)'],
        correctAnswer: '5(x + 3)',
        correctFeedback: 'Good work! 5 is a common factor: 5(x + 3).',
        incorrectFeedback: 'Look for the largest number that divides both terms.'
      },
      {
        type: 'text-response',
        question: 'Factorise: x² - 2x',
        acceptedAnswers: ['x(x - 2)', 'x(x-2)', '(x - 2)x', '(x-2)x', 'x*(x-2)', 'x*(x - 2)'],
        correctAnswer: 'x(x - 2)',
        correctFeedback: 'Well done! Factor out x, leaving x(x - 2).',
        incorrectFeedback: 'Look for a common x factor.'
      },
      {
        type: 'text-response',
        question: 'Solve for x: x/4 = 9',
        acceptedAnswers: ['x = 36', 'x=36', '36', 'x = 36.0', 'x=36.0'],
        correctAnswer: 'x = 36',
        correctFeedback: 'Great! Multiply both sides by 4: x = 36.',
        incorrectFeedback: 'Multiply 9 by 4 to solve for x.'
      },
      {
        type: 'text-response',
        question: 'Solve for x: x² = 81',
        acceptedAnswers: ['x = 9', 'x=9', '9', 'x = -9', 'x=-9', '-9', 'x = ±9', 'x=±9', '±9', 'x = 9 or x = -9', 'x=9 or x=-9'],
        correctAnswer: 'x = ±9',
        correctFeedback: 'Correct! Both 9 and -9 satisfy x² = 81.',
        incorrectFeedback: 'Remember, both positive and negative square roots are possible.'
      },
      {
        type: 'text-response',
        question: 'Solve for x: x² - 25 = 0',
        acceptedAnswers: ['x = 5', 'x=5', '5', 'x = -5', 'x=-5', '-5', 'x = ±5', 'x=±5', '±5', 'x = 5 or x = -5', 'x=5 or x=-5'],
        correctAnswer: 'x = ±5',
        correctFeedback: 'Well done! Both 5 and -5 are solutions.',
        incorrectFeedback: 'Add 25, then take the square root in both directions.'
      },
      {
        type: 'text-response',
        question: 'Twice a number plus 8 is 30. Find the number.',
        acceptedAnswers: ['n = 11', 'n=11', '11', 'x = 11', 'x=11', 'number = 11', 'number=11', 'the number is 11'],
        correctAnswer: '11',
        correctFeedback: 'Excellent! 2 × 11 + 8 = 30.',
        incorrectFeedback: 'Subtract 8 first, then divide by 2.'
      }
    ];

    // Initialize game
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for authentication
      const checkAuth = setInterval(() => {
        if (window.jandoAuth && jandoAuth.isAuthenticated()) {
          initializeGame();
          clearInterval(checkAuth);
        }
      }, 100);

      // Also listen for auth completion event
      window.addEventListener('jandoAuthComplete', (event) => {
        setTimeout(() => {
          initializeGame();
        }, 500);
      });
    });

    function initializeGame() {
      updateTotalQuestions();
      displayQuestion();
      updateProgress();
    }

    function updateTotalQuestions() {
      // Only update the element that still exists (totalQuestionsDisplay in the question counter)
      const totalQuestionsElement = document.getElementById('totalQuestionsDisplay');
      if (totalQuestionsElement) {
        totalQuestionsElement.textContent = questions.length;
      }
    }

    function displayQuestion() {
      const question = questions[currentQuestionIndex];
      const questionArea = document.getElementById('questionArea');
      
      let html = `
        <div class="question-container">
          <div class="question-number">Question ${currentQuestionIndex + 1}</div>
          <div class="question-text">${formatMath(question.question)}</div>
      `;

      if (question.type === 'multiple-choice') {
        html += '<div class="options">';
        question.options.forEach((option, index) => {
          const isSelected = userAnswers[currentQuestionIndex] === index;
          html += `
            <div class="option ${isSelected ? 'selected' : ''}" onclick="selectOption(${index})">
              <input type="radio" name="q${currentQuestionIndex}" value="${index}" ${isSelected ? 'checked' : ''}>
              <span>${formatMath(option)}</span>
            </div>
          `;
        });
        html += '</div>';
      } else {
        const userAnswer = userAnswers[currentQuestionIndex] || '';
        html += `
          <input type="text" class="text-input" id="textInput${currentQuestionIndex}" 
                 placeholder="Enter your answer here..." 
                 value="${userAnswer}"
                 onkeyup="handleTextInput(event)"
                 onchange="updateTextAnswer()">
          <div style="margin-top: 1rem; text-align: center;">
            <button class="btn btn-primary" onclick="submitTextAnswer()" id="textSubmitBtn" ${userAnswer ? '' : 'disabled'}>
              Submit Answer
            </button>
          </div>
        `;
      }

      html += '<div class="feedback" id="feedback"></div>';
      html += '</div>';
      
      questionArea.innerHTML = html;
      
      updateNavigationButtons();
    }

    function formatMath(text) {
      // Replace ^2 with ² and other mathematical formatting
      let formatted = text.replace(/\^2/g, '<span class="superscript">2</span>')
                          .replace(/x\^2/g, 'x<span class="superscript">2</span>')
                          .replace(/y\^2/g, 'y<span class="superscript">2</span>')
                          .replace(/a\^2/g, 'a<span class="superscript">2</span>')
                          .replace(/\\\(/g, '')
                          .replace(/\\\)/g, '')
                          .replace(/\\times/g, '×')
                          .replace(/\\pm/g, '±');
      
      // Convert fractions like x/4, (x+1)/3, etc. to proper fraction display
      // Handle simple fractions first (variable or number / number or variable)
      formatted = formatted.replace(/\b([a-zA-Z0-9]+)\/([a-zA-Z0-9]+)\b/g, function(match, numerator, denominator) {
        return `<span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span>`;
      });
      
      // Handle more complex fractions with parentheses
      formatted = formatted.replace(/\(([^)]+)\)\/\(([^)]+)\)/g, function(match, numerator, denominator) {
        return `<span class="fraction"><span class="numerator">(${numerator})</span><span class="denominator">(${denominator})</span></span>`;
      });
      
      // Handle fractions with parentheses on one side only
      formatted = formatted.replace(/\(([^)]+)\)\/([a-zA-Z0-9]+)/g, function(match, numerator, denominator) {
        return `<span class="fraction"><span class="numerator">(${numerator})</span><span class="denominator">${denominator}</span></span>`;
      });
      
      formatted = formatted.replace(/([a-zA-Z0-9]+)\/\(([^)]+)\)/g, function(match, numerator, denominator) {
        return `<span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">(${denominator})</span></span>`;
      });
      
      return formatted;
    }

    function selectOption(optionIndex) {
      // Initialize first attempt tracking
      if (!window.firstAttempts) window.firstAttempts = {};
      
      const questionKey = `q${currentQuestionIndex}`;
      
      // Capture FIRST ATTEMPT (this is what gets saved to Google Sheets)
      if (!window.firstAttempts[questionKey]) {
        const question = questions[currentQuestionIndex];
        const selectedText = question.options[optionIndex];
        const correctText = question.options[question.correct];
        
        window.firstAttempts[questionKey] = {
          question: question.question,
          selectedAnswer: selectedText,      // LOCKED - First attempt answer text
          correctAnswer: correctText,
          selectedIndex: optionIndex,        // LOCKED - First attempt index
          correctIndex: question.correct,
          isCorrect: optionIndex === question.correct,
          timestamp: new Date().toISOString()
        };
        
        console.log(`🔒 FIRST ATTEMPT LOCKED for Question ${currentQuestionIndex + 1}:`, {
          selected: selectedText,
          correct: correctText,
          wasCorrect: optionIndex === question.correct
        });
      } else {
        console.log(`📝 Subsequent attempt for Question ${currentQuestionIndex + 1} (first attempt already locked: "${window.firstAttempts[questionKey].selectedAnswer}")`);
      }
      
      // Update current answer (this can change for UI feedback)
      userAnswers[currentQuestionIndex] = optionIndex;
      
      // Update visual selection
      document.querySelectorAll('.option').forEach((opt, idx) => {
        opt.classList.remove('selected', 'correct', 'incorrect');
        const radio = opt.querySelector('input[type="radio"]');
        radio.checked = idx === optionIndex;
      });
      
      // Mark currently selected option
      const selectedOption = document.querySelectorAll('.option')[optionIndex];
      selectedOption.classList.add('selected');
      
      // Show DYNAMIC feedback - changes as they select different options
      const question = questions[currentQuestionIndex];
      const isCurrentCorrect = optionIndex === question.correct;
      const feedbackElement = document.getElementById('feedback');
      
      if (isCurrentCorrect) {
        selectedOption.classList.add('correct');
        feedbackElement.className = 'feedback correct';
        feedbackElement.textContent = question.correctFeedback;
      } else {
        selectedOption.classList.add('incorrect');
        feedbackElement.className = 'feedback incorrect';
        feedbackElement.textContent = question.incorrectFeedback;
        
        // Also highlight correct answer for learning (but faded)
        const correctOption = document.querySelectorAll('.option')[question.correct];
        correctOption.style.border = '2px solid var(--green)';
        correctOption.style.opacity = '0.7';
      }
      
      feedbackElement.style.display = 'block';
      updateNavigationButtons();
    }

    function handleTextInput(event) {
      if (event.key === 'Enter') {
        submitTextAnswer();
      } else {
        updateTextAnswer(); // Update button state and clear feedback, but don't check answer
      }
    }

    function updateTextAnswer() {
      const input = document.getElementById(`textInput${currentQuestionIndex}`);
      if (input) {
        const value = input.value.trim();
        
        // Initialize first attempt tracking
        if (!window.firstAttempts) window.firstAttempts = {};
        
        const questionKey = `q${currentQuestionIndex}`;
        
        // Don't capture first attempt here - wait for submit button
        
        userAnswers[currentQuestionIndex] = value;
        
        // Clear any existing feedback when changing the answer
        const feedback = document.getElementById('feedback');
        if (feedback) {
          feedback.style.display = 'none';
          feedback.className = 'feedback';
          feedback.textContent = '';
        }
        
        // Update submit button state
        const submitBtn = document.getElementById('textSubmitBtn');
        if (submitBtn) {
          submitBtn.disabled = !value;
        }
        
        updateNavigationButtons();
      }
    }

    function submitTextAnswer() {
      const input = document.getElementById(`textInput${currentQuestionIndex}`);
      if (input && input.value.trim()) {
        const value = input.value.trim();
        
        // Initialize first attempt tracking
        if (!window.firstAttempts) window.firstAttempts = {};
        
        const questionKey = `q${currentQuestionIndex}`;
        
        // Capture FIRST ATTEMPT when submit button is pressed (this is what gets saved to Google Sheets)
        if (!window.firstAttempts[questionKey]) {
          const question = questions[currentQuestionIndex];
          const acceptableAnswers = question.acceptedAnswers;
          const isCorrectFirst = acceptableAnswers.some(answer => 
            answer.toLowerCase().trim() === value.toLowerCase().trim()
          );
          
          window.firstAttempts[questionKey] = {
            question: question.question,
            selectedAnswer: value,                    // LOCKED - First attempt answer
            correctAnswer: acceptableAnswers[0],      // Primary correct answer
            acceptableAnswers: acceptableAnswers,     // All acceptable variations
            isCorrect: isCorrectFirst,
            timestamp: new Date().toISOString()
          };
          
          console.log(`🔒 FIRST ATTEMPT LOCKED for Question ${currentQuestionIndex + 1}:`, {
            answer: value,
            correctOptions: acceptableAnswers,
            wasCorrect: isCorrectFirst
          });
        } else {
          console.log(`📝 Subsequent attempt for Question ${currentQuestionIndex + 1} (first attempt already locked: "${window.firstAttempts[questionKey].selectedAnswer}")`);
        }
        
        updateTextAnswer();
        checkAnswer();
        
        // Mark this text question as submitted
        submittedTextAnswers[currentQuestionIndex] = true;
        
        // Show feedback immediately and enable navigation
        const feedback = document.getElementById('feedback');
        if (feedback) {
          feedback.style.display = 'block';
        }
        
        // Update navigation buttons to enable next button
        updateNavigationButtons();
        
        // Ensure feedback is generated for text responses
        const question = questions[currentQuestionIndex];
        if (question.type === 'text-response') {
          const normalizedUserAnswer = value.toLowerCase().replace(/\s/g, '');
          const isCorrect = question.acceptedAnswers.some(answer => 
            answer.toLowerCase().replace(/\s/g, '') === normalizedUserAnswer
          );
          
          feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
          feedback.textContent = isCorrect ? question.correctFeedback : question.incorrectFeedback;
          feedback.style.display = 'block';
        }
        
        // Focus the submit button briefly to show submission happened
        const submitBtn = document.getElementById('textSubmitBtn');
        if (submitBtn) {
          submitBtn.textContent = 'Submitted ✓';
          submitBtn.style.background = 'var(--light-blue)';
          setTimeout(() => {
            submitBtn.textContent = 'Submit Answer';
            submitBtn.style.background = 'var(--orange)';
          }, 1000);
        }
      }
    }

    function checkAnswer() {
      const question = questions[currentQuestionIndex];
      const feedback = document.getElementById('feedback');
      const userAnswer = userAnswers[currentQuestionIndex];
      
      if (userAnswer === undefined || userAnswer === '') return;
      
      let isCorrect = false;
      
      if (question.type === 'multiple-choice') {
        isCorrect = userAnswer === question.correct;
      } else {
        // Text response - check against accepted answers
        const normalizedUserAnswer = userAnswer.toLowerCase().replace(/\s/g, '');
        isCorrect = question.acceptedAnswers.some(answer => 
          answer.toLowerCase().replace(/\s/g, '') === normalizedUserAnswer
        );
      }
      
      feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
      feedback.textContent = isCorrect ? question.correctFeedback : question.incorrectFeedback;
      feedback.style.display = 'block';
      
      // Update score (only once per question)
      if (!userAnswers[`scored_${currentQuestionIndex}`]) {
        if (isCorrect) {
          score++;
          updateScore();
        }
        userAnswers[`scored_${currentQuestionIndex}`] = true;
      }
    }

    function updateScore() {
      // Score display has been removed from the progress bar
      // Score is now only shown at the end in results
      // This function is kept for compatibility but does nothing
    }

    function updateProgress() {
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      prevBtn.disabled = currentQuestionIndex === 0;
      
      const hasAnswer = userAnswers[currentQuestionIndex] !== undefined && userAnswers[currentQuestionIndex] !== '';
      const currentQuestion = questions[currentQuestionIndex];
      
      // For text questions, require both answer AND submission before enabling next
      let canProceed = hasAnswer;
      if (currentQuestion && currentQuestion.type === 'text-response') {
        canProceed = hasAnswer && submittedTextAnswers[currentQuestionIndex] === true;
      }
      
      nextBtn.disabled = !canProceed;
      
      if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = canProceed ? 'inline-block' : 'none';
      } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
        updateProgress();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1 && userAnswers[currentQuestionIndex] !== undefined) {
        currentQuestionIndex++;
        displayQuestion();
        updateProgress();
      }
    }

    async function submitGame() {
      if (gameCompleted) return;
      
      gameCompleted = true;
      
      // Show loading screen immediately
      jandoLoading.show();
      
      // Initialize first attempts if not exists
      if (!window.firstAttempts) window.firstAttempts = {};
      
      // Calculate score USING FIRST ATTEMPTS (for Google Sheets)
      let firstAttemptScore = 0;
      const firstAttemptResponses = [];
      
      // Also calculate current score for display
      let currentScore = 0;
      const currentResponses = [];
      
      questions.forEach((question, index) => {
        const questionKey = `q${index}`;
        const currentAnswer = userAnswers[index];
        
        // 🔒 FIRST ATTEMPT DATA (saved to Google Sheets)
        const firstAttempt = window.firstAttempts[questionKey];
        let firstAttemptAnswer = 'No answer';
        let firstAttemptCorrect = false;
        
        if (firstAttempt) {
          firstAttemptAnswer = firstAttempt.selectedAnswer;
          firstAttemptCorrect = firstAttempt.isCorrect;
          if (firstAttemptCorrect) firstAttemptScore++;
        }
        
        // 📝 CURRENT ANSWER DATA (for display)
        let currentCorrect = false;
        let currentAnswerText = '';
        
        if (question.type === 'multiple-choice') {
          currentCorrect = currentAnswer === question.correct;
          currentAnswerText = question.options[currentAnswer] || 'No answer';
        } else {
          const normalizedCurrentAnswer = (currentAnswer || '').toLowerCase().replace(/\s/g, '');
          currentCorrect = question.acceptedAnswers.some(answer => 
            answer.toLowerCase().replace(/\s/g, '') === normalizedCurrentAnswer
          );
          currentAnswerText = currentAnswer || 'No answer';
        }
        
        if (currentCorrect) currentScore++;
        
        // Prepare responses for Google Sheets (FIRST ATTEMPTS ONLY)
        firstAttemptResponses.push({
          question: question.question,
          correct: question.correctAnswer,
          answer: firstAttemptAnswer,           // 🔒 LOCKED FIRST ATTEMPT
          isCorrect: firstAttemptCorrect
        });
        
        // Prepare responses for display (current answers)
        currentResponses.push({
          question: question.question,
          correct: question.correctAnswer,
          answer: currentAnswerText,
          isCorrect: currentCorrect,
          firstAttempt: firstAttemptAnswer,      // Show first attempt in results
          firstAttemptCorrect: firstAttemptCorrect
        });
      });
      
      console.log(`📊 SUBMISSION SUMMARY:
        First Attempt Score: ${firstAttemptScore}/${questions.length} (saved to Google Sheets)
        Current Score: ${currentScore}/${questions.length} (shown to student)`);
      
      // Save FIRST ATTEMPTS to Google Sheets
      await saveGameResults(firstAttemptScore, firstAttemptResponses);
      
      // Complete the loading progress and show results
      jandoLoading.complete();
      
      // Show CURRENT results to student after a brief delay
      setTimeout(() => {
        jandoLoading.hide();
        showResults(currentScore, currentResponses);
      }, 500);
    }

    async function saveGameResults(finalScore, responses) {
      if (!jandoAuth.isAuthenticated()) {
        console.error('User not authenticated');
        return;
      }

      const user = jandoAuth.getCurrentUser();
      const gameData = {
        code: user.code,
        score: finalScore,
        totalQuestions: questions.length,
        game: "Y9M-W1-Algebra",
        sheet: "Y9M-W1-Algebra",
        responses: responses
      };

      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbzwNZGb_nRFF9t4lLdJdbII1kuDKhsiy4_liBxOe3pNc6rWP7swfem33C_ALT3OWQ9GoQ/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(gameData)
        });

        // With no-cors mode, we can't read the response, but the request will go through
        console.log('Game results sent to Google Sheets (no-cors mode)');
      } catch (error) {
        console.error('Error saving game results:', error);
        // Fallback: try saving to localStorage for later sync
        localStorage.setItem('pendingGameResult_' + Date.now(), JSON.stringify(gameData));
        console.log('Game data saved locally as backup');
      }
    }

    function showResults(finalScore, responses) {
      document.getElementById('questionArea').style.display = 'none';
      document.querySelector('.game-controls').style.display = 'none';
      
      const resultsScreen = document.getElementById('resultsScreen');
      const percentage = Math.round((finalScore / questions.length) * 100);
      
      // Calculate first attempt score for comparison
      const firstAttemptCount = responses.filter(r => r.firstAttemptCorrect).length;
      const firstAttemptPercentage = Math.round((firstAttemptCount / questions.length) * 100);
      
      // Display first attempt score prominently under "Test Complete"
      document.getElementById('firstAttemptScore').innerHTML = `
        <div style="color: var(--dark-blue); font-size: 1.2rem; font-weight: normal; margin-bottom: 0.5rem;">Score</div>
        <div style="font-size: 2.5rem; color: var(--orange); font-weight: bold;">${firstAttemptCount}/${questions.length}</div>
      `;
      
      // Remove the second score display as requested
      
      let message = '';
      if (percentage >= 90) {
        message = '🌟 Outstanding! You have mastered algebra fundamentals!';
      } else if (percentage >= 80) {
        message = '🎉 Excellent work! You have a strong grasp of algebra!';
      } else if (percentage >= 70) {
        message = '👍 Good job! Keep practicing to improve further!';
      } else if (percentage >= 60) {
        message = '📚 You\'re getting there! Review the concepts and try again!';
      } else {
        message = '💪 Keep studying! Algebra takes practice - don\'t give up!';
      }
      
      document.getElementById('resultsMessage').textContent = message;
      
      // Show improvement information if final score is different from first attempt
      if (firstAttemptCount !== finalScore) {
        const improvementInfo = document.createElement('div');
        improvementInfo.style.cssText = 'margin-top: 15px; padding: 12px; background-color: #f0f9ff; border-radius: 8px; font-size: 14px; border-left: 4px solid var(--light-blue);';
        const improvement = finalScore - firstAttemptCount;
        const improvementText = improvement > 0 ? 
          `📈 Great job! You improved by ${improvement} question${improvement > 1 ? 's' : ''} through learning and corrections.` :
          `📊 Your consistent performance shows good understanding of the material.`;
        improvementInfo.innerHTML = `
          <strong>Learning Progress:</strong><br>
          ${improvementText}<br>
          <small style="color: var(--gray-600); margin-top: 5px; display: block;">
            Final Score: ${finalScore}/${questions.length} (${percentage}%) - After exploring feedback
          </small>
        `;
        document.getElementById('resultsMessage').parentElement.appendChild(improvementInfo);
      }
      
      // Show detailed results
      const correctCount = responses.filter(r => r.isCorrect).length;
      const incorrectCount = responses.length - correctCount;
      
      document.getElementById('resultsDetails').innerHTML = `
        <h3>Detailed Results</h3>
        <p><strong>Correct answers:</strong> ${correctCount}</p>
        <p><strong>Incorrect answers:</strong> ${incorrectCount}</p>
        <p><strong>Percentage:</strong> ${percentage}%</p>
      `;
      
      resultsScreen.style.display = 'block';
      
      // Check for reward (80% or higher gets a reward)
      if (percentage >= 80) {
        setTimeout(() => {
          giveReward();
        }, 1000); // Show reward after 1 second delay
      } else {
        // If no reward, show return home button
        setTimeout(() => {
          showReturnHomeButton();
        }, 1000);
      }
    }

    function showReturnHomeButton() {
      // Only add return button if it doesn't already exist
      if (document.querySelector('.return-home-btn')) return;
      
      const returnBtn = document.createElement('button');
      returnBtn.className = 'return-home-btn';
      returnBtn.innerHTML = '🏠 Return to Games';
      returnBtn.style.cssText = `
        margin: 2rem auto;
        padding: 1rem 2rem;
        display: block;
        background: var(--orange);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      `;
      returnBtn.onmouseover = () => returnBtn.style.transform = 'translateY(-2px)';
      returnBtn.onmouseout = () => returnBtn.style.transform = 'translateY(0)';
      returnBtn.onclick = () => window.location.href = 'games.html';
      
      document.getElementById('resultsScreen').appendChild(returnBtn);
    }

    function giveReward() {
      const scriptURL = 'https://script.google.com/macros/s/AKfycbzwNZGb_nRFF9t4lLdJdbII1kuDKhsiy4_liBxOe3pNc6rWP7swfem33C_ALT3OWQ9GoQ/exec';
      
      if (!jandoAuth.isAuthenticated()) {
        console.error('User not authenticated for rewards');
        showReturnHomeButton();
        return;
      }

      const user = jandoAuth.getCurrentUser();
      
      fetch(scriptURL + "?rewards=" + encodeURIComponent(user.code))
        .then(res => res.json())
        .then(data => {
          let currentRewards = Array.isArray(data.rewards) ? data.rewards : (data.rewards ? data.rewards.split("") : []);
          let available = animals.filter(a => !currentRewards.includes(a));
          if (available.length === 0) {
            // All animals collected
            const additionalInfo = document.createElement('p');
            additionalInfo.style.cssText = 'margin-top: 15px; padding: 10px; background-color: #fff3cd; border-radius: 5px; font-size: 14px; color: var(--dark-blue);';
            additionalInfo.innerHTML = `🎉 Amazing! You've collected all the animals! You're a true algebra master! 🎉`;
            document.getElementById('resultsMessage').parentElement.appendChild(additionalInfo);
            showReturnHomeButton();
            return;
          }
          currentReward = available[Math.floor(Math.random() * available.length)];
          
          // Show the modal popup
          document.getElementById("rewardModal").style.display = "block";
          document.getElementById("rewardDisplay").innerText = "🎁";
          document.getElementById("rewardMessage").innerText = "Click the present to reveal your reward!";
          document.getElementById("rewardButtons").style.display = "none";
          
          // Save reward to sheet
          fetch(scriptURL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ code: user.code, reward: currentReward }),
            headers: { "Content-Type": "application/json" }
          });
        })
        .catch(err => {
          console.error("Reward error:", err);
          showReturnHomeButton();
        });
    }
    
    function revealReward() {
      document.getElementById("rewardDisplay").innerText = currentReward;
      document.getElementById("rewardDisplay").style.animation = "wiggle 1s infinite";
      document.getElementById("rewardMessage").innerText = "🎉 You earned a new animal friend! 🎉";
      document.getElementById("rewardButtons").style.display = "block";
      
      // Remove click ability after reveal
      document.getElementById("rewardDisplay").onclick = null;
      document.getElementById("rewardDisplay").style.cursor = "default";
      
      // Confetti animation
      for (let i = 0; i < 50; i++) {
        let confetti = document.createElement("div");
        confetti.className = "confetti";
        confetti.style.left = Math.random() * 100 + "vw";
        confetti.style.backgroundColor = ["#E15C31","#A6BFFF","#22277A","#FFD700","#32CD32"][Math.floor(Math.random()*5)];
        confetti.style.animationDuration = (2 + Math.random() * 3) + "s";
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 3000);
      }
    }
    
    function closeRewardModal() {
      document.getElementById("rewardModal").style.display = "none";
      // Reset for next time
      document.getElementById("rewardDisplay").onclick = revealReward;
      document.getElementById("rewardDisplay").style.cursor = "pointer";
      document.getElementById("rewardDisplay").style.animation = "";
      
      // Show return home button after closing modal
      showReturnHomeButton();
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
      let modal = document.getElementById("rewardModal");
      if (event.target === modal) {
        closeRewardModal();
      }
    }



    function restartGame() {
      currentQuestionIndex = 0;
      score = 0;
      userAnswers = [];
      submittedTextAnswers = [];
      gameCompleted = false;
      
      document.getElementById('questionArea').style.display = 'block';
      document.querySelector('.game-controls').style.display = 'flex';
      document.getElementById('resultsScreen').style.display = 'none';
      jandoLoading.hide();
      
      updateScore();
      displayQuestion();
      updateProgress();
    }
  </script>
</body>
</html>